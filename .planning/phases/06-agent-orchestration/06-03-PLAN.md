---
phase: 06-agent-orchestration
plan: 03
type: execute
wave: 2
depends_on:
  - "06-01"
  - "06-02"
files_modified: []
autonomous: false

must_haves:
  truths:
    - "NOVA hooks correctly subscribe to message:received in OpenClaw 2026.2.17"
    - "Sending a message causes entity extraction in PostgreSQL within 60 seconds"
    - "A follow-up query recalls the extracted entity (semantic recall works)"
    - "Cron/webhook sessions do not appear in main chat session history"
    - "Sub-agents use the haiku model (not primary model) as confirmed by run logs"
  artifacts:
    - path: "/data/.openclaw/hooks/memory-extract"
      provides: "memory-extract hook handler with message:received subscription"
    - path: "/data/.openclaw/hooks/semantic-recall"
      provides: "semantic-recall hook handler (import path verified)"
    - path: "/data/.openclaw/agents/main/sessions"
      provides: "Session transcripts (catch-up cron reads from here)"
  key_links:
    - from: "OpenClaw gateway (message:received event)"
      to: "/data/.openclaw/hooks/memory-extract/handler"
      via: "hook event subscription in HOOK.md"
      pattern: "message:received"
    - from: "memory-extract hook"
      to: "PostgreSQL entities table"
      via: "psycopg2 / NOVA extract pipeline"
      pattern: "entities"
    - from: "semantic-recall hook"
      to: "/data/nova-relationships/lib/entity-resolver"
      via: "relative import ../../../nova-relationships/"
      pattern: "nova-relationships"
---

<objective>
Verify NOVA hooks correctly wire to `message:received` in 2026.2.17, validate the full memory extraction pipeline end-to-end, and confirm session isolation is working.

Purpose: NOVA was designed for `message:received` hooks, but prior research flagged an open question: has the NOVA repo been updated to declare this event in its hook manifests for 2026.2.17? This plan answers that question and validates the complete pipeline: message → hook fires → entity extracted → PostgreSQL record → semantic recall on follow-up.

Output: Confirmed working memory pipeline with documented evidence, plus sub-agent token routing validation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-agent-orchestration/06-RESEARCH.md
@.planning/phases/06-agent-orchestration/06-02-SUMMARY.md
@.planning/phases/04-memory-system/04-NOVA-AUDIT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inspect NOVA hook manifests and verify message:received subscription</name>
  <files></files>
  <action>
SSH into the container and inspect the NOVA hook manifests to determine whether they subscribe to `message:received` in the version installed. This answers the open question from the research doc.

**Step 1: Get container name**
```bash
CONTAINER=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 'sudo docker ps --format "{{.Names}}" | grep openclaw | head -1')
```

**Step 2: Check hook manifests (HOOK.md or similar) for event declarations**
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER find /data/.openclaw/hooks -name 'HOOK.md' -o -name 'hook.json' -o -name 'manifest.json' 2>/dev/null | xargs grep -l 'message:received' 2>/dev/null"
```

```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER find /data/.openclaw/hooks -name 'HOOK.md' 2>/dev/null | xargs cat 2>/dev/null"
```

**Step 3: List installed hooks with status**
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER openclaw hooks list 2>/dev/null || echo 'hooks list failed'"
```
Look for: `memory-extract`, `semantic-recall`, `session-init` all showing as active (not "missing").

**Step 4: Check the NOVA Memory git log to confirm version**
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER git -C /data/clawd/nova-memory log --oneline -5 2>/dev/null"
```

**Step 5: If semantic-recall shows as "missing" — apply the import fix**
The Phase 4 audit identified that semantic-recall may fail to load if the nova-relationships symlink or NODE_PATH is not correct. If `openclaw hooks list` shows semantic-recall as missing:

```bash
# Check symlink exists
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER ls -la /data/.openclaw/nova-relationships 2>/dev/null"

# If symlink is missing, create it
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER ln -sf /data/nova-relationships /data/.openclaw/nova-relationships 2>/dev/null && echo 'symlink created'"

# Re-enable hook
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER openclaw hooks enable semantic-recall 2>/dev/null || echo 'enable failed'"
```

**Step 6: If HOOK.md does not declare message:received — document as finding**
If hook manifests don't declare `message:received`, this means hooks are installed but won't fire on new messages. The catch-up cron (running every 5 min) remains the active memory extraction path. Document the finding in the summary. The system still works — recall fires at session-init (a confirmed event), extraction happens via cron.

Record findings: which hooks are active, whether message:received is declared, NOVA repo version.
  </action>
  <verify>
```bash
CONTAINER=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 'sudo docker ps --format "{{.Names}}" | grep openclaw | head -1')
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER openclaw hooks list 2>/dev/null"
```
Expected: All three hooks listed (memory-extract, semantic-recall, session-init). If any show "missing", the fix steps above must be applied.
  </verify>
  <done>Hook manifest inspection complete. NOVA hook status documented. semantic-recall symlink verified or fixed. Findings (whether message:received fires or cron is primary) recorded for summary.</done>
</task>

<task type="auto">
  <name>Task 2: End-to-end memory pipeline test — extract and recall</name>
  <files></files>
  <action>
Run the complete memory pipeline test: send a test message, wait for extraction, verify entity in PostgreSQL, then send a recall query and verify it succeeds.

**Step 1: Send a memorable test message via openclaw eval**
```bash
CONTAINER=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 'sudo docker ps --format "{{.Names}}" | grep openclaw | head -1')

sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER openclaw eval 'Remember for testing: my test project is called ProjectAlphaTest and uses TypeScript' 2>/dev/null"
```

**Step 2: Wait for memory extraction (up to 60 seconds for hooks, up to 5 min for cron)**
```bash
# Wait 60 seconds for hook-based extraction (if message:received fires)
sleep 60

# Check PostgreSQL for extracted entities
# First, get credentials from postgres.json (env vars not available in docker exec)
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER sh -c 'cat /data/.openclaw/postgres.json' 2>/dev/null"
```
Use the host/user/password/database values from postgres.json for the psql command:
```bash
# Replace values from postgres.json output above
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER psql -h <host> -U <user> -d <database> -c 'SELECT name, type, created_at FROM entities ORDER BY created_at DESC LIMIT 5;' 2>/dev/null"
```

**Step 3: If entity count is 0 after 60s — manually trigger catch-up cron**
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER bash /data/clawd/nova-memory/scripts/memory-catchup.sh --log 2>/dev/null"
```
Then re-run the entity count query.

**Step 4: Check catch-up log**
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER tail -30 /tmp/nova-catchup.log 2>/dev/null || echo 'no catchup log yet'"
```

**Step 5: Test semantic recall**
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER openclaw eval 'What do you remember about my test project?' 2>/dev/null"
```
Expected: Response should reference "ProjectAlphaTest" and "TypeScript" from the stored memory.

**Step 6: Verify session isolation — confirm cron sessions don't pollute main chat**
```bash
# List recent sessions to verify catch-up sessions use isolated keys
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER ls -lt /data/.openclaw/agents/main/sessions/ 2>/dev/null | head -10"
```
The memory-catchup.sh script runs outside the OpenClaw gateway (system cron calling a shell script directly), so it does NOT create gateway sessions at all. This is correct behavior — isolation is guaranteed by architecture, not config.

Document: how many entities were extracted, whether hooks or cron was the extraction mechanism, and whether semantic recall returned relevant results.
  </action>
  <verify>
```bash
# Verify postgres.json is readable and entity count after extraction
CONTAINER=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 'sudo docker ps --format "{{.Names}}" | grep openclaw | head -1')
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER sh -c 'cat /data/.openclaw/postgres.json' 2>/dev/null"
```
Pass: entity count > 0 after test message + extraction trigger. Fail: 0 entities after manual catch-up run.
  </verify>
  <done>At least 1 entity extracted to PostgreSQL from the test message. Semantic recall query returns a response that references the test entity. Session isolation verified (cron runs outside gateway session system). Extraction mechanism documented (hooks vs cron).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of memory recall and sub-agent token routing</name>
  <action>
Task 1 verified hook manifests and NOVA hook status. Task 2 ran the full memory pipeline: sent a test message, triggered extraction, verified entities in PostgreSQL, and tested semantic recall. Sub-agent model routing was configured in Plan 01 and applied in Plan 02.

Please verify the following in the OpenClaw chat interface and via SSH:

**Memory Recall Test:**
1. Open the OpenClaw chat interface at http://192.168.1.100:18789
2. Start a new conversation (or use the main session)
3. Type: "What do you remember about ProjectAlphaTest?"
4. Expected: The response should reference "ProjectAlphaTest" and "TypeScript" from the extracted memory. If it says it has no memory of it, note whether entity extraction succeeded in Task 2 logs.

**Sub-Agent Token Check (if you have a task that spawns sub-agents):**
1. Ask the agent: "Research and summarize the top 3 uses of TypeScript in 2026, using sub-agents if helpful"
2. After the response, SSH in and check logs for sub-agent model references:
   - Run: `sudo docker logs <container> 2>&1 | grep -i "haiku\|sub-agent\|spawn" | tail -20`
3. Expected: logs should reference haiku model for spawned sub-agents

**Session Isolation Check:**
1. Check that your main chat history is clean — no automated catch-up output appeared in chat
2. Run: `sudo docker exec <container> crontab -l` — verify memory-catchup entry is present with HOME=/data
  </action>
  <verify>
Memory recall returns relevant results OR the reason it doesn't (entity extraction failure) is documented. Sub-agent logs show haiku model if sub-agents were spawned. Main chat history has no automated cron output.
  </verify>
  <done>Human confirmed: memory recall works (or failure reason documented), session isolation confirmed (no cron output in main chat), sub-agent model routing verified via logs.</done>
  <resume-signal>Type "approved" if memory recall worked and system is healthy, or describe specific issues for follow-up</resume-signal>
</task>

</tasks>

<verification>
Phase 6 success criteria verification:
1. `openclaw hooks list` shows memory-extract, semantic-recall, session-init (all active)
2. PostgreSQL `entities` table has rows after sending a test message
3. Semantic recall query returns relevant response referencing extracted entity
4. Catch-up cron entry present in crontab (system cron, NOT openclaw native cron)
5. openclaw.json has `agents.defaults.subagents.model = "anthropic/claude-haiku-4-5"`
6. Gateway healthy (HTTP 200)
</verification>

<success_criteria>
- NOVA hooks installed and active (memory-extract, semantic-recall, session-init)
- Memory extraction pipeline works: message → entities in PostgreSQL
- Semantic recall returns relevant results from extracted memory
- Sub-agent model routing configured with haiku model
- Session isolation confirmed (cron runs outside gateway session system)
- All Phase 6 roadmap success criteria verifiably met
</success_criteria>

<output>
After completion, create `.planning/phases/06-agent-orchestration/06-03-SUMMARY.md`
</output>
