---
phase: 06-agent-orchestration
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - AGENTS.md
  - memory/patterns/preferences.md
  - memory/patterns/sandbox-creation.md
  - memory/patterns/n8n-workflows.md
autonomous: true
must_haves:
  truths:
    - "Agent has explicit instructions for when and how to read/write memory"
    - "Knowledge base seed files exist in memory/patterns/ with domain-specific content"
    - "memory_search returns results when queried for known patterns"
    - "AGENTS.md is synced to workspace via bootstrap.sh seed mechanism"
  artifacts:
    - path: "AGENTS.md"
      provides: "Memory discipline protocol for the AI agent"
      contains: "memory_search"
    - path: "memory/patterns/preferences.md"
      provides: "User preference patterns"
      contains: "PREFER"
    - path: "memory/patterns/sandbox-creation.md"
      provides: "Sandbox creation patterns"
      contains: "WORKS"
    - path: "memory/patterns/n8n-workflows.md"
      provides: "n8n workflow patterns"
      contains: "WORKS"
  key_links:
    - from: "scripts/bootstrap.sh"
      to: "AGENTS.md"
      via: "seed_agent copies to workspace"
      pattern: "AGENTS.md"
    - from: "AGENTS.md"
      to: "memory/patterns/"
      via: "agent reads patterns on task start"
      pattern: "memory_search"
---

<objective>
Create AGENTS.md (memory discipline instructions for the AI agent) and seed the memory/patterns/ knowledge base with domain-specific pattern files. Update bootstrap.sh to sync AGENTS.md to the workspace alongside SOUL.md and BOOTSTRAP.md. Verify memory_search works end-to-end.

Purpose: Give the agent clear instructions on when to search memory, how to record learnings, and provide an initial knowledge base of patterns from prior phases so memory_search has content to index.
Output: AGENTS.md in repo root, memory/patterns/ directory with 3 seed files, bootstrap.sh updated to sync AGENTS.md.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/bootstrap.sh
@.planning/phases/06-agent-orchestration/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AGENTS.md and memory/patterns/ seed files</name>
  <files>AGENTS.md, memory/patterns/preferences.md, memory/patterns/sandbox-creation.md, memory/patterns/n8n-workflows.md</files>
  <action>
**Create AGENTS.md in repo root** with the following content. This file is the agent's memory discipline protocol — it tells the agent how to use memory_search and when to write patterns.

AGENTS.md content:
```markdown
# Agent Memory Protocol

## Before Every Task

Run 2-3 `memory_search` queries relevant to the domain before starting work:
- Search for the specific task type (e.g., "sandbox creation", "n8n workflow")
- Search for user preferences related to the domain
- Search for known failures or gotchas

Example: Before creating a sandbox, search for "sandbox creation patterns" and "sandbox failures".

## After Every Task

If you learned something new (a workaround, a failure, a user preference), write it to the appropriate file in `memory/patterns/`:

### Pattern File Format

Each entry uses this format:
```
### [Short description]
- **Date**: YYYY-MM-DD
- **Status**: WORKS | FAILS | PREFER | AVOID
- **Context**: [When this applies]
- **Detail**: [What to do or not do]
```

### Domain Files
- `memory/patterns/preferences.md` — User preferences and workflow choices
- `memory/patterns/sandbox-creation.md` — Sandbox creation and management patterns
- `memory/patterns/n8n-workflows.md` — n8n workflow creation and API patterns
- Create new domain files as needed: `memory/patterns/<domain>.md`

## Memory Hygiene

- Keep each pattern file under 200 lines (HDD indexing performance)
- Use WORKS/FAILS/PREFER/AVOID status markers for quick scanning
- Include dates so stale patterns can be identified
- Do NOT duplicate content already in MEMORY.md — that file is curated long-term memory
- Weekly: review patterns older than 30 days, archive or delete stale ones

## Sub-Agent Instructions

Sub-agents (running on Haiku) should:
- Always `memory_search` before starting their subtask
- Report learnings back to the parent agent for pattern recording
- Do NOT write to pattern files directly (parent agent curates)

## What NOT to Memorize

- Temporary debugging steps
- One-off commands that won't recur
- Secrets, tokens, or credentials (NEVER)
- Information already in SOUL.md, BOOTSTRAP.md, or MEMORY.md
```

**Create memory/patterns/ directory and seed files.**

`memory/patterns/preferences.md`:
```markdown
# User Preferences

### Direct action over planning
- **Date**: 2026-02-21
- **Status**: PREFER
- **Context**: All tasks
- **Detail**: User prefers concise instructions and direct action. Avoid lengthy explanations or formal planning overhead.

### Root user for container
- **Date**: 2026-02-21
- **Status**: PREFER
- **Context**: Docker container runtime
- **Detail**: Container runs as root. Non-root was attempted but reverted due to HDD permission issues. Do not attempt non-root again.

### Pin versions in Dockerfile
- **Date**: 2026-02-21
- **Status**: PREFER
- **Context**: Dockerfile, package installs
- **Detail**: HDD server is slow. Pin all install versions to avoid unnecessary downloads on rebuild. Include checksums where possible.

### sudo required for docker
- **Date**: 2026-02-21
- **Status**: WORKS
- **Context**: SSH commands to 192.168.1.100
- **Detail**: User ameer is not in docker group. All docker commands need sudo.
```

`memory/patterns/sandbox-creation.md`:
```markdown
# Sandbox Creation Patterns

### Basic sandbox creation
- **Date**: 2026-02-21
- **Status**: WORKS
- **Context**: Creating new project sandboxes
- **Detail**: Use `create_sandbox.sh --stack nextjs --title "name"`. Input validation rejects SQL injection attempts and invalid characters.

### Docker socket proxy restrictions
- **Date**: 2026-02-21
- **Status**: WORKS
- **Context**: Sandbox Docker operations
- **Detail**: Docker socket proxy allows CONTAINERS + IMAGES + VOLUMES only. EXEC and global POST are disabled. Cannot docker exec from within the container.

### Container ID validation
- **Date**: 2026-02-21
- **Status**: WORKS
- **Context**: Recovery scripts
- **Detail**: recover_sandbox.sh validates container IDs match openclaw naming pattern before any operations.
```

`memory/patterns/n8n-workflows.md`:
```markdown
# n8n Workflow Patterns

### API authentication
- **Date**: 2026-02-21
- **Status**: WORKS
- **Context**: n8n API calls
- **Detail**: N8N_API_KEY is stored in /data/.openclaw/credentials/N8N_API_KEY (file, not env var). Read from file before API calls.

### Webhook to OpenClaw
- **Date**: 2026-02-21
- **Status**: WORKS
- **Context**: n8n triggering OpenClaw actions
- **Detail**: n8n sends POST to OpenClaw hooks endpoint. Hooks token required in Authorization header. Session key prefixed with "hook:" for isolation.

### Credential isolation pattern
- **Date**: 2026-02-21
- **Status**: PREFER
- **Context**: Any external service credentials
- **Detail**: Write credential to /data/.openclaw/credentials/<NAME> file, chmod 600, then unset from env. Read from file when needed.
```
  </action>
  <verify>
Verify files exist and have content:
- `test -f AGENTS.md && wc -l AGENTS.md` (should be ~50+ lines)
- `test -f memory/patterns/preferences.md && wc -l memory/patterns/preferences.md` (should be ~25+ lines)
- `test -f memory/patterns/sandbox-creation.md && wc -l memory/patterns/sandbox-creation.md`
- `test -f memory/patterns/n8n-workflows.md && wc -l memory/patterns/n8n-workflows.md`
- `grep -l "memory_search" AGENTS.md` (confirms key instruction present)
- `grep -l "WORKS\|FAILS\|PREFER" memory/patterns/*.md` (confirms format used)
  </verify>
  <done>AGENTS.md exists with memory discipline protocol. memory/patterns/ has 3 seed files (preferences, sandbox-creation, n8n-workflows) using WORKS/FAILS/PREFER format.</done>
</task>

<task type="auto">
  <name>Task 2: Update bootstrap.sh to sync AGENTS.md and memory/patterns/ to workspace</name>
  <files>scripts/bootstrap.sh</files>
  <action>
**Modify the seed_agent function in bootstrap.sh** to also sync AGENTS.md alongside SOUL.md and BOOTSTRAP.md.

In the `seed_agent` function, find the `for doc in SOUL.md BOOTSTRAP.md; do` loop (around line 58). Change it to:
```bash
for doc in SOUL.md BOOTSTRAP.md AGENTS.md; do
```

This uses the existing cmp-based sync mechanism: copies from /app/ (repo) to workspace if missing or changed. No new code needed — just adding AGENTS.md to the list.

**Also add memory/patterns/ seeding** after the SOUL/BOOTSTRAP/AGENTS loop but before `return 0`. Add:
```bash
    # Seed memory/patterns/ knowledge base (only copies missing files, never overwrites)
    if [ -d "/app/memory/patterns" ]; then
      mkdir -p "$dir/memory/patterns"
      for pattern in /app/memory/patterns/*.md; do
        local basename=$(basename "$pattern")
        if [ ! -f "$dir/memory/patterns/$basename" ]; then
          cp "$pattern" "$dir/memory/patterns/$basename"
          echo "[seed] Copied memory/patterns/$basename"
        fi
      done
    fi
```

Note: Unlike AGENTS.md which uses cmp to update on change, pattern files are NOT overwritten if they exist. The agent modifies these files during operation, so repo versions are just seeds. Only missing files are copied.

**Then commit and deploy:**
```bash
git add AGENTS.md memory/patterns/ scripts/bootstrap.sh
git commit -m "feat(06): add AGENTS.md memory protocol, seed knowledge base patterns"
git push origin main
```

Wait for Coolify deploy (~5 min). Then verify files landed in workspace:
```bash
CONTAINER=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker ps --filter 'name=openclaw' --format '{{.Names}}' | head -1")

sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER ls -la /data/openclaw-workspace/AGENTS.md /data/openclaw-workspace/memory/patterns/"
```
  </action>
  <verify>
1. `bash -n scripts/bootstrap.sh` passes (no syntax errors)
2. `grep "AGENTS.md" scripts/bootstrap.sh` confirms AGENTS.md is in the seed list
3. `grep "memory/patterns" scripts/bootstrap.sh` confirms pattern seeding code exists
4. SSH verify AGENTS.md in workspace:
   ```
   sshpass -p '@pack86N5891' ssh ... ameer@192.168.1.100 \
     "sudo docker exec $CONTAINER test -f /data/openclaw-workspace/AGENTS.md && echo EXISTS || echo MISSING"
   ```
5. SSH verify memory patterns in workspace:
   ```
   sshpass -p '@pack86N5891' ssh ... ameer@192.168.1.100 \
     "sudo docker exec $CONTAINER ls /data/openclaw-workspace/memory/patterns/"
   ```
   Should show preferences.md, sandbox-creation.md, n8n-workflows.md
  </verify>
  <done>AGENTS.md syncs to workspace on every deploy. memory/patterns/ seed files are copied on first deploy. Agent can read AGENTS.md for memory discipline and memory_search can index the pattern files.</done>
</task>

<task type="auto">
  <name>Task 3: Verify memory_search works end-to-end via Control UI or API</name>
  <files></files>
  <action>
**Test that memory_search actually indexes and returns results.**

After deploy completes and gateway is healthy, test memory search via the OpenClaw API. Use curl to send a message that triggers memory_search:

```bash
TOKEN="b934d627a0dcc6a08c4e7a156067f865e54dba925beb0047"

# Send a test message that should trigger memory search
curl -s -X POST "http://192.168.1.100:18789/api/agents/main/message" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"message": "Search your memory for sandbox creation patterns and tell me what you find."}' | jq .
```

If the API endpoint is different (OpenClaw may use a different path), check:
```bash
curl -s "http://192.168.1.100:18789/api" -H "Authorization: Bearer $TOKEN" | jq .
```

**Alternative: Check config was loaded correctly by the gateway.**
```bash
CONTAINER=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker ps --filter 'name=openclaw' --format '{{.Names}}' | head -1")

# Check gateway logs for memorySearch initialization
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker logs --tail 50 $CONTAINER 2>&1 | grep -i 'memory\|search\|embed\|index'"
```

If memory indexing appears in logs (e.g., "indexing memory sources", "embedding", "memory search ready"), the feature is working. If there are errors about OPENAI_API_KEY, verify the key is available (it should be loaded via BWS secrets).

**Fallback check if API test is inconclusive:**
Verify the config is structurally correct:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER jq '.agents.defaults.memorySearch' /data/.openclaw/openclaw.json"
```
Should return the full memorySearch object with enabled: true.

**Bug #10963 check for subagents:**
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker logs --tail 100 $CONTAINER 2>&1 | grep -i 'sub.*agent\|haiku\|model.*select'"
```
If sub-agent model is NOT being respected (still showing Sonnet), note this for a future fix using per-agent list entries instead of defaults. This is a known bug (#10963) and the workaround is documented in research.
  </action>
  <verify>
At least ONE of these must be true:
1. Gateway logs show memory indexing activity (grep for "memory" or "index" or "embed" in logs)
2. API message response references content from memory/patterns/ files
3. Config file has complete memorySearch object with enabled: true

AND: Gateway is healthy (curl returns 200 or 401)
  </verify>
  <done>memory_search is configured and the gateway loads the config without errors. Pattern files are in the workspace and available for indexing. Sub-agent model configuration is in place (with bug #10963 noted if defaults are ignored).</done>
</task>

</tasks>

<verification>
1. AGENTS.md exists in repo root and workspace (/data/openclaw-workspace/AGENTS.md)
2. memory/patterns/ has 3 seed files in both repo and workspace
3. bootstrap.sh syncs AGENTS.md on deploy (in seed_agent list)
4. bootstrap.sh seeds memory/patterns/ on first deploy (mkdir + cp loop)
5. Gateway boots without errors
6. memorySearch config is loaded (visible in openclaw.json)
</verification>

<success_criteria>
- Agent has AGENTS.md with explicit memory read/write protocol
- Knowledge base has seed content for memory_search to index
- Files sync to workspace on deploy via bootstrap.sh
- memory_search is functional (config loaded, no gateway errors)
</success_criteria>

<output>
After completion, create `.planning/phases/06-agent-orchestration/06-02-SUMMARY.md`
</output>
