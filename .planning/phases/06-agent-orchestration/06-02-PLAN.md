---
phase: 06-agent-orchestration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: false

user_setup:
  - service: coolify
    why: "Enable NOVA Memory by setting environment variable in Coolify dashboard"
    dashboard_config:
      - task: "Set NOVA_MEMORY_ENABLED=true environment variable"
        location: "Coolify Dashboard -> openclaw application -> Environment Variables -> add NOVA_MEMORY_ENABLED with value true -> Save -> Restart (not Redeploy)"

must_haves:
  truths:
    - "NOVA Memory boots without errors (bootstrap.sh nova block runs)"
    - "PostgreSQL connection succeeds from within the container"
    - "Three NOVA hooks are installed: memory-extract, semantic-recall, session-init"
    - "The catch-up cron entry is present in crontab"
  artifacts:
    - path: "/data/.openclaw/postgres.json"
      provides: "NOVA PostgreSQL connection config (generated by bootstrap.sh)"
      contains: "host"
    - path: "/data/clawd/nova-memory"
      provides: "NOVA Memory git clone on persistent volume"
    - path: "/data/.openclaw/hooks/"
      provides: "Installed NOVA hook handlers"
  key_links:
    - from: "scripts/bootstrap.sh NOVA block"
      to: "postgres-memory service"
      via: "TCP check on NOVA_MEMORY_DB_HOST:NOVA_MEMORY_DB_PORT"
      pattern: "NOVA_MEMORY_DB_HOST"
    - from: "agent-install.sh"
      to: "/data/.openclaw/hooks/"
      via: "hook installation"
      pattern: "openclaw hooks enable"
---

<objective>
Activate NOVA Memory by enabling it in Coolify, then verify the full NOVA boot sequence succeeds.

Purpose: NOVA Memory is already installed in bootstrap.sh but gated behind `NOVA_MEMORY_ENABLED=false`. Setting this env var to `true` in Coolify and restarting the container triggers the entire NOVA boot sequence: PostgreSQL check, git clone/pull, schema application, hook installation, and catch-up cron setup.

Output: A running OpenClaw container with NOVA Memory active, hooks installed, and catch-up cron running.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@scripts/bootstrap.sh
@.planning/phases/06-agent-orchestration/06-RESEARCH.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Enable NOVA_MEMORY_ENABLED in Coolify and restart container</name>
  <action>
In the Coolify dashboard for the openclaw application, add environment variable `NOVA_MEMORY_ENABLED=true`, save, then restart the container. Restart (not Redeploy) reuses the existing image and is fast (~30 seconds).

Steps:
1. Open Coolify dashboard at your Coolify URL
2. Navigate to the openclaw application
3. Go to Environment Variables
4. Add: `NOVA_MEMORY_ENABLED` = `true`
5. Save
6. Click Restart (NOT Redeploy — restart is sufficient for env var changes)
7. Wait ~30 seconds for container to restart

Note: If the container takes longer than 2 minutes to restart, check Coolify logs — PostgreSQL connection may be timing out if `postgres-memory` service is not running.

Also confirm: `NOVA_MEMORY_DB_HOST`, `NOVA_MEMORY_DB_PORT`, `NOVA_MEMORY_DB_USER`, `NOVA_MEMORY_DB_PASSWORD`, `NOVA_MEMORY_DB_NAME` are already set in Coolify (these were set in Phase 4). If any are missing, check the Phase 4 summary before proceeding.
  </action>
  <verify>Container shows as running in Coolify with no startup errors in logs.</verify>
  <done>Container restarted successfully with NOVA_MEMORY_ENABLED=true set in environment.</done>
  <resume-signal>Type "restarted" when the container has restarted successfully, or describe any errors</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Verify NOVA Memory boot sequence via container logs</name>
  <files></files>
  <action>
SSH into the server and check container logs to verify the NOVA Memory boot sequence completed successfully.

Run the following checks in order:

**Step 1: Get container name (it changes every deploy)**
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 'sudo docker ps --format "{{.Names}}" | grep openclaw | head -1'
```

**Step 2: Check NOVA boot log lines**
```bash
CONTAINER=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 'sudo docker ps --format "{{.Names}}" | grep openclaw | head -1')
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker logs $CONTAINER 2>&1 | grep -E '^\[nova\]'"
```

Expected log lines (all must be present):
- `[nova] NOVA Memory enabled, waiting for PostgreSQL...`
- `[nova] PostgreSQL ready`
- `[nova] Updated NOVA Memory` (or `Cloned NOVA Memory` on first run)
- `[nova] Updated NOVA Relationships` (or `Cloned NOVA Relationships`)
- `[nova] Entity-resolver deps installed`
- `[nova] Generated postgres.json`
- `[nova] Schema applied`
- `[nova] Catch-up processor cron enabled (every 5 min)`

**Step 3: Verify sub-agent config was applied (from Plan 01 patch)**
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker logs $CONTAINER 2>&1 | grep 'sub-agent'"
```
Expected: `[config] Added sub-agent model routing (haiku for sub-agents)`

**Step 4: Verify crontab has catch-up entry**
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker exec $CONTAINER crontab -l 2>/dev/null | grep memory-catchup"
```
Expected: a cron entry containing `memory-catchup.sh` with `HOME=/data` and PostgreSQL env vars.

**Step 5: Verify gateway is still healthy**
```bash
curl -s -o /dev/null -w "%{http_code}" http://192.168.1.100:18789/
```
Expected: 200 (not 503 or connection refused — gateway crash would mean openclaw.json got invalid key).

If gateway returns non-200 or connection refuses: check for config validation errors in docker logs. The most likely cause is an invalid key in openclaw.json from the sub-agent patch. If so, SSH in and check: `sudo docker exec $CONTAINER cat /data/.openclaw/openclaw.json | jq '.agents.defaults'`
  </action>
  <verify>
All five checks pass:
1. `[nova]` log lines show full boot sequence (PostgreSQL ready through schema applied)
2. `[config] Added sub-agent model routing` in logs
3. crontab contains memory-catchup.sh entry
4. Gateway HTTP check returns 200

If any check fails, document which log lines are missing and what error appears.
  </verify>
  <done>NOVA Memory boot sequence complete: PostgreSQL connected, hooks installed, catch-up cron active, sub-agent config applied, gateway healthy.</done>
</task>

</tasks>

<verification>
Full verification after both tasks:
```bash
# Gateway health
curl -s -o /dev/null -w "%{http_code}" http://192.168.1.100:18789/

# NOVA boot logs
CONTAINER=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 'sudo docker ps --format "{{.Names}}" | grep openclaw | head -1')
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 "sudo docker logs $CONTAINER 2>&1 | grep -E '^\[nova\]|sub-agent'"
```
</verification>

<success_criteria>
- NOVA_MEMORY_ENABLED=true is set in Coolify env vars
- Container restarted without errors
- All expected `[nova]` log lines present (PostgreSQL ready through cron enabled)
- Sub-agent model routing config was applied ([config] log line)
- Gateway is healthy (HTTP 200)
- Catch-up cron entry present in crontab
</success_criteria>

<output>
After completion, create `.planning/phases/06-agent-orchestration/06-02-SUMMARY.md`
</output>
