---
phase: 06-agent-orchestration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/bootstrap.sh
autonomous: true

must_haves:
  truths:
    - "Sub-agents use a cheaper model (claude-haiku-4-5) instead of inheriting the primary model"
    - "Cron jobs run in isolated sessions that do not appear in main chat history"
    - "Sub-agent config is idempotent — re-running bootstrap.sh does not duplicate or corrupt it"
  artifacts:
    - path: "scripts/bootstrap.sh"
      provides: "Sub-agent model routing config and session isolation cron config"
      contains: "agents.defaults.subagents"
  key_links:
    - from: "scripts/bootstrap.sh"
      to: "/data/.openclaw/openclaw.json"
      via: "jq patch block for agents.defaults.subagents"
      pattern: "agents\\.defaults\\.subagents"
    - from: "system cron (crontab)"
      to: "memory-catchup.sh"
      via: "cron entry with HOME=/data — runs independently of OpenClaw gateway session system"
      pattern: "memory-catchup\\.sh"
---

<objective>
Configure sub-agent model routing and enforce session isolation for cron/webhook processing.

Purpose: Without explicit sub-agent config, all sub-agents inherit the primary expensive model (Opus/Sonnet), burning tokens on tasks that Haiku handles fine. Cron jobs without session isolation contaminate main chat history with automated output.

Output: A bootstrap.sh jq patch block that sets `agents.defaults.subagents.model` to `anthropic/claude-haiku-4-5` and verifies cron session isolation config is correct.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/bootstrap.sh
@.planning/phases/06-agent-orchestration/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sub-agent model routing jq patch to bootstrap.sh</name>
  <files>scripts/bootstrap.sh</files>
  <action>
Add a new jq patch block to bootstrap.sh immediately after the hooks patch block (after line ~227, before the NOVA Memory section). The patch must be idempotent — only apply if `agents.defaults.subagents` is not already set.

Insert the following block at the correct position in bootstrap.sh:

```bash
# Patch: add sub-agent model routing (cheaper model for sub-agents, not primary model)
if command -v jq &>/dev/null && [ -f "$CONFIG_FILE" ]; then
  HAS_SUBAGENTS=$(jq -r '.agents.defaults.subagents // empty' "$CONFIG_FILE" 2>/dev/null)
  if [ -z "$HAS_SUBAGENTS" ]; then
    jq '.agents.defaults.subagents = {
      "model": "anthropic/claude-haiku-4-5",
      "maxSpawnDepth": 1,
      "maxChildrenPerAgent": 3,
      "maxConcurrent": 4,
      "archiveAfterMinutes": 60
    }' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
    echo "[config] Added sub-agent model routing (haiku for sub-agents)"
  fi
fi
```

CRITICAL: Do NOT add any key not in the official OpenClaw config schema. The keys `model`, `maxSpawnDepth`, `maxChildrenPerAgent`, `maxConcurrent`, `archiveAfterMinutes` are all documented in `agents.defaults.subagents` per the research doc. Do NOT add `experimental.*` keys — unknown keys crash the gateway.

The model string `anthropic/claude-haiku-4-5` follows OpenClaw's provider/model format. If at runtime `openclaw models list` shows a different alias, the config can be updated after verification (Plan 03).

Position: Insert AFTER the hooks patch block (the `fi` that closes the `if [ "$HOOKS_ENABLED" != "true" ]` block on ~line 227) and BEFORE the NOVA Memory Installation section.
  </action>
  <verify>
Run:
```bash
grep -A 12 "sub-agent model routing" /Users/ameerakashe/Documents/repos/openclaw-coolify/scripts/bootstrap.sh
```
Expected: the jq patch block is present with `agents.defaults.subagents` containing `model`, `maxSpawnDepth`, `maxChildrenPerAgent`, `maxConcurrent`, `archiveAfterMinutes`.

Also verify no syntax errors:
```bash
bash -n /Users/ameerakashe/Documents/repos/openclaw-coolify/scripts/bootstrap.sh
```
Expected: exits 0 with no output.
  </verify>
  <done>bootstrap.sh contains the sub-agent jq patch block, `bash -n` passes, and the patch is positioned between the hooks patch block and the NOVA Memory section.</done>
</task>

<task type="auto">
  <name>Task 2: Verify cron session isolation defaults in bootstrap.sh NOVA block</name>
  <files>scripts/bootstrap.sh</files>
  <action>
Audit the existing NOVA catch-up cron entry in bootstrap.sh to verify it has correct session isolation. The memory-catchup cron runs via system cron (not OpenClaw native cron) and calls a shell script directly — it does NOT have a `sessionTarget` field because it's not an OpenClaw native cron job. This is correct: system cron is independent of the gateway session system, providing session isolation by architecture rather than configuration.

However, update the comment above the NOVA catch-up cron entry in bootstrap.sh to clarify why system cron is used (independence + reliability), and update the log comment to remove the outdated reference to "message:received hook not yet implemented" since 2026.2.17 now supports this.

Specifically:
1. Find the CATCHUP_CRON variable assignment in bootstrap.sh (~line 396). The current comment says "workaround: message:received hook not yet implemented". Update it to say "safety net: runs even if message:received hooks miss messages during container restarts".
2. Update the `[nova] NOVA Memory disabled` echo message at the end of the NOVA block (~line 404) to remove reference to issue #8807 since that's now resolved. Change it to: `echo "[nova] NOVA Memory disabled (set NOVA_MEMORY_ENABLED=true in Coolify to enable)"`
3. Update the condition comment near line 299 from "Currently disabled: message:received hook not implemented in OpenClaw through 2026.2.15" to "Enable via NOVA_MEMORY_ENABLED=true in Coolify env vars. OpenClaw 2026.2.17+ supports message:received hooks."

No functional changes to the CATCHUP_CRON command itself — the HOME=/data and PG variables are already correct from the existing implementation.
  </action>
  <verify>
```bash
grep -n "message:received\|#8807\|safety net\|NOVA Memory disabled" /Users/ameerakashe/Documents/repos/openclaw-coolify/scripts/bootstrap.sh
```
Expected: No references to "message:received hook not yet implemented" or "issue #8807". The new comments reference 2026.2.17 and "safety net".

```bash
bash -n /Users/ameerakashe/Documents/repos/openclaw-coolify/scripts/bootstrap.sh
```
Expected: exits 0.
  </verify>
  <done>bootstrap.sh comments are updated to reflect 2026.2.17 state, all stale issue references removed, bash syntax check passes.</done>
</task>

</tasks>

<verification>
After both tasks:
1. `bash -n scripts/bootstrap.sh` exits 0 — no syntax errors
2. `grep "agents.defaults.subagents" scripts/bootstrap.sh` returns the jq patch block
3. `grep "anthropic/claude-haiku-4-5" scripts/bootstrap.sh` confirms model string
4. `grep "safety net" scripts/bootstrap.sh` confirms comment update
5. No references to "#8807" remain in bootstrap.sh
</verification>

<success_criteria>
- bootstrap.sh has an idempotent jq patch for `agents.defaults.subagents` with haiku model
- NOVA catch-up cron comment updated to reflect 2026.2.17 state
- All stale issue references removed from bootstrap.sh
- bash -n passes (no syntax errors)
- Ready for Coolify redeploy (Plan 02 enables NOVA via env var, which triggers the NOVA block)
</success_criteria>

<output>
After completion, create `.planning/phases/06-agent-orchestration/06-01-SUMMARY.md`
</output>
