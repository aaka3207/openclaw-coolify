---
phase: 06-agent-orchestration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/bootstrap.sh
autonomous: true
must_haves:
  truths:
    - "memorySearch is enabled in openclaw.json with openai provider and text-embedding-3-small model"
    - "Sub-agent model defaults to anthropic/claude-haiku-4-5 in openclaw.json"
    - "NOVA catch-up cron entry is removed from the running container's crontab"
    - "Gateway boots successfully with the new config patches"
  artifacts:
    - path: "scripts/bootstrap.sh"
      provides: "jq patches for memorySearch and subagents config"
      contains: "memorySearch"
  key_links:
    - from: "scripts/bootstrap.sh"
      to: "/data/.openclaw/openclaw.json"
      via: "jq patch at boot"
      pattern: "jq.*memorySearch"
---

<objective>
Add jq config patches to bootstrap.sh for OpenClaw built-in memory (memorySearch with OpenAI embeddings) and sub-agent model routing (Haiku for sub-agents). Clean up stale NOVA catch-up cron from the running container. Deploy and verify gateway boots cleanly.

Purpose: Enable OpenClaw's native hybrid memory system (BM25 + vector) and reduce token costs by routing sub-agents to Haiku. Remove dead NOVA infrastructure that was a workaround for broken hooks.
Output: Updated bootstrap.sh with two new jq patch blocks. Running container verified healthy with new config.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/bootstrap.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add memorySearch and subagents jq patches to bootstrap.sh</name>
  <files>scripts/bootstrap.sh</files>
  <action>
Add two new jq patch blocks to bootstrap.sh, placed AFTER the existing hooks patch block (around line 227) and BEFORE the "Export state" section. Follow the exact same idempotent pattern used by existing patches (check if value exists, only patch if missing/different, write to .tmp then mv).

**Patch 1: memorySearch**
Check if `agents.defaults.memorySearch.enabled` is true. If not, patch the full memorySearch config:
```bash
MEMORY_SEARCH=$(jq -r '.agents.defaults.memorySearch.enabled // false' "$CONFIG_FILE" 2>/dev/null)
if [ "$MEMORY_SEARCH" != "true" ]; then
  jq '.agents.defaults.memorySearch = {
    "enabled": true,
    "provider": "openai",
    "model": "text-embedding-3-small",
    "sources": ["memory"],
    "sync": {"watch": true, "onSearch": true, "onSessionStart": true},
    "query": {
      "maxResults": 10,
      "minScore": 0.25,
      "hybrid": {
        "enabled": true,
        "vectorWeight": 0.7,
        "textWeight": 0.3,
        "mmr": {"enabled": true, "lambda": 0.7},
        "temporalDecay": {"enabled": true, "halfLifeDays": 30}
      }
    }
  }' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
  echo "[config] Enabled memorySearch (openai/text-embedding-3-small, hybrid BM25+vector)"
fi
```

**Patch 2: subagents model**
Check if `agents.defaults.subagents.model.primary` is set. If not, patch:
```bash
SUBAGENT_MODEL=$(jq -r '.agents.defaults.subagents.model.primary // empty' "$CONFIG_FILE" 2>/dev/null)
if [ -z "$SUBAGENT_MODEL" ]; then
  jq '.agents.defaults.subagents = {
    "model": {"primary": "anthropic/claude-haiku-4-5"},
    "maxSpawnDepth": 2,
    "maxChildrenPerAgent": 5,
    "maxConcurrent": 8,
    "archiveAfterMinutes": 60
  }' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
  echo "[config] Set sub-agent model to anthropic/claude-haiku-4-5"
fi
```

IMPORTANT: These patches go in the existing `if command -v jq &>/dev/null && [ -f "$CONFIG_FILE" ]; then` block, after the hooks patch (line ~226) and before the closing `fi` on line ~227. Keep them inside the same conditional.

Also: In the NOVA Memory section (line ~391-401), change the catch-up cron setup to be a no-op comment. Replace the entire block from `# Memory catch-up processor` through the `fi` after `crontab` with:
```bash
# Memory catch-up processor — DISABLED: using built-in memorySearch instead of NOVA hooks
# Legacy cron removed 2026-02-21. To clean stale entries: crontab -l | grep -v memory-catchup | crontab -
```

Do NOT remove the entire NOVA section — it's still gated behind NOVA_MEMORY_ENABLED=true and might be re-enabled. Only comment out the catch-up cron part.
  </action>
  <verify>
Run: `cd /Users/ameerakashe/Documents/repos/openclaw-coolify && bash -n scripts/bootstrap.sh` to verify no syntax errors.
Then grep to confirm patches exist:
- `grep -c "memorySearch" scripts/bootstrap.sh` should return >= 2
- `grep -c "subagents" scripts/bootstrap.sh` should return >= 2
- `grep -c "DISABLED.*memorySearch" scripts/bootstrap.sh` should return 1
  </verify>
  <done>bootstrap.sh has idempotent jq patches for memorySearch (openai, text-embedding-3-small, hybrid) and subagents (haiku). NOVA catch-up cron setup is commented out. Script passes bash -n syntax check.</done>
</task>

<task type="auto">
  <name>Task 2: Deploy, clean stale NOVA cron, and verify gateway health</name>
  <files>scripts/bootstrap.sh</files>
  <action>
**Step 1: Commit and push bootstrap.sh changes.**
Stage and commit: `git add scripts/bootstrap.sh && git commit -m "feat(06): add memorySearch + subagents jq patches, disable NOVA catch-up cron"`
Push to main: `git push origin main`

**Step 2: Wait for Coolify auto-deploy.**
Coolify auto-deploys on push to main. Wait ~5 minutes (code-only change uses cached Docker layers). Monitor with:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker ps --filter 'name=openclaw' --format '{{.Names}} {{.Status}}'"
```
Repeat every 30 seconds until container shows "Up" with a recent timestamp (< 2 minutes ago).

**Step 3: Clean stale NOVA catch-up cron from running container.**
Find the container name first:
```bash
CONTAINER=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker ps --filter 'name=openclaw' --format '{{.Names}}' | head -1")
```
Then remove the memory-catchup cron entry:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER bash -c 'crontab -l 2>/dev/null | grep -v memory-catchup | crontab - && echo CLEANED || echo NO_CRON'"
```

**Step 4: Verify config patches applied.**
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER jq '.agents.defaults.memorySearch.enabled, .agents.defaults.subagents.model.primary' /data/.openclaw/openclaw.json"
```
Expected output: `true` and `"anthropic/claude-haiku-4-5"`.

**Step 5: Verify gateway is healthy.**
```bash
curl -s -o /dev/null -w "%{http_code}" http://192.168.1.100:18789/
```
Expected: 200 or 401 (both mean gateway is running).

If config patches did NOT apply (values missing), it means the config already existed and the check condition evaluated to skip. In that case, force-patch by running the jq commands directly via docker exec:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER bash -c 'jq \".agents.defaults.memorySearch = {\\\"enabled\\\": true, \\\"provider\\\": \\\"openai\\\", \\\"model\\\": \\\"text-embedding-3-small\\\", \\\"sources\\\": [\\\"memory\\\"], \\\"sync\\\": {\\\"watch\\\": true, \\\"onSearch\\\": true, \\\"onSessionStart\\\": true}, \\\"query\\\": {\\\"maxResults\\\": 10, \\\"minScore\\\": 0.25, \\\"hybrid\\\": {\\\"enabled\\\": true, \\\"vectorWeight\\\": 0.7, \\\"textWeight\\\": 0.3, \\\"mmr\\\": {\\\"enabled\\\": true, \\\"lambda\\\": 0.7}, \\\"temporalDecay\\\": {\\\"enabled\\\": true, \\\"halfLifeDays\\\": 30}}}}\" /data/.openclaw/openclaw.json > /tmp/oc.tmp && mv /tmp/oc.tmp /data/.openclaw/openclaw.json'"
```
Then restart gateway: the user may need to trigger a Coolify restart.
  </action>
  <verify>
SSH verify all three conditions:
1. `sudo docker exec $CONTAINER jq '.agents.defaults.memorySearch.enabled' /data/.openclaw/openclaw.json` returns `true`
2. `sudo docker exec $CONTAINER jq '.agents.defaults.subagents.model.primary' /data/.openclaw/openclaw.json` returns `"anthropic/claude-haiku-4-5"`
3. `sudo docker exec $CONTAINER crontab -l 2>/dev/null | grep -c memory-catchup` returns `0`
4. `curl -s -o /dev/null -w "%{http_code}" http://192.168.1.100:18789/` returns 200 or 401
  </verify>
  <done>Gateway is running with memorySearch enabled (openai/text-embedding-3-small, hybrid mode), sub-agent model set to haiku, and NOVA catch-up cron removed from container crontab.</done>
</task>

</tasks>

<verification>
1. bootstrap.sh passes `bash -n` syntax check
2. openclaw.json on server has `agents.defaults.memorySearch.enabled = true`
3. openclaw.json on server has `agents.defaults.subagents.model.primary = "anthropic/claude-haiku-4-5"`
4. Container crontab has no `memory-catchup` entries
5. Gateway responds to HTTP requests (200 or 401)
</verification>

<success_criteria>
- OpenClaw gateway boots with memorySearch enabled and subagents configured
- Built-in memory system uses OpenAI text-embedding-3-small for vector search
- Sub-agents default to Haiku model
- NOVA catch-up cron is cleaned from running container
- Changes are idempotent (safe on redeploy)
</success_criteria>

<output>
After completion, create `.planning/phases/06-agent-orchestration/06-01-SUMMARY.md`
</output>
