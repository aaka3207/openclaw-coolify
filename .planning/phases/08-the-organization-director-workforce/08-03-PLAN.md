---
phase: 08-the-organization-director-workforce
plan: 03
type: execute
wave: 3
depends_on: ["08-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "n8n Global Error Trigger workflow exists and is active"
    - "When any n8n workflow fails, the error handler POSTs to hook:automation-supervisor"
    - "The POST payload includes agentId, sessionKey, and structured error message"
  artifacts:
    - path: "n8n workflow: openclaw-error-handler"
      provides: "Global error trigger -> OpenClaw hook"
  key_links:
    - from: "n8n error handler workflow"
      to: "http://192.168.1.100:18789/hooks/agent"
      via: "HTTP Request node with agentId + sessionKey"
      pattern: "hook:automation-supervisor"
---

<objective>
Create the n8n Global Error Trigger workflow that routes all workflow failures to the Automation Supervisor.

Purpose: This is the entry point for the self-healing loop. When any n8n workflow fails, the error fires a webhook to the Supervisor's session, enabling automated diagnosis and repair.

Output:
- n8n workflow with Error Trigger node + HTTP Request to OpenClaw hooks
- Workflow set as Global Error Workflow in n8n Settings
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-the-organization-director-workforce/08-RESEARCH.md
@ARCHITECTURE_REFINEMENT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create n8n error handler workflow via API</name>
  <files></files>
  <action>
**Pre-check: Confirm 08-01 changes are deployed**

Before creating the workflow, verify the Automation Supervisor is live (08-01 must be deployed first):
```bash
CONTAINER=$(sudo docker ps --format '{{.Names}}' | grep openclaw | head -1)
sudo docker exec "$CONTAINER" jq -r '.agents.list[] | select(.id == "automation-supervisor") | .id' /data/.openclaw/openclaw.json
# Expected: "automation-supervisor"
# If empty: push and deploy 08-01 changes first, wait for Coolify rebuild to complete
```

**Create the n8n error handler workflow**

Use the n8n API to create the error handler workflow. Read the N8N_API_KEY from the credential file on the server, or use the n8n-manager skill if available.

**Workflow structure:**
```json
{
  "name": "OpenClaw Error Handler",
  "nodes": [
    {
      "name": "Error Trigger",
      "type": "n8n-nodes-base.errorTrigger",
      "position": [250, 300],
      "parameters": {}
    },
    {
      "name": "POST to Automation Supervisor",
      "type": "n8n-nodes-base.httpRequest",
      "position": [500, 300],
      "parameters": {
        "method": "POST",
        "url": "http://192.168.1.100:18789/hooks/agent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{$env.OPENCLAW_HOOKS_TOKEN}}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "agentId", "value": "automation-supervisor" },
            { "name": "sessionKey", "value": "hook:automation-supervisor" },
            { "name": "name", "value": "n8n-error-trigger" },
            { "name": "wakeMode", "value": "now" },
            { "name": "deliver", "value": "={{false}}" },
            { "name": "message", "value": "=n8n workflow '{{ $json.workflow.name }}' (ID: {{ $json.workflow.id }}) failed at node '{{ $json.execution.lastNodeExecuted }}'. Error: {{ $json.execution.error.message }}. Execution URL: {{ $json.execution.url }}. Diagnose and fix if possible. Check memory/patterns/n8n-error-recovery.md for known patterns first." }
          ]
        }
      }
    }
  ],
  "connections": {
    "Error Trigger": {
      "main": [[{ "node": "POST to Automation Supervisor", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
```

**Create via n8n API:**
```bash
# SSH to server, exec into container
CONTAINER=$(sudo docker ps --format '{{.Names}}' | grep openclaw | head -1)

# Read API key and hooks token
N8N_KEY=$(sudo docker exec "$CONTAINER" cat /data/.openclaw/credentials/N8N_API_KEY)
HOOKS_TOKEN=$(sudo docker exec "$CONTAINER" jq -r '.hooks.token' /data/.openclaw/openclaw.json)

# Create workflow
curl -X POST "http://192.168.1.100:5678/api/v1/workflows" \
  -H "X-N8N-API-KEY: $N8N_KEY" \
  -H "Content-Type: application/json" \
  -d '<workflow JSON above>'

# Activate the workflow
WORKFLOW_ID=<id from response>
curl -X PATCH "http://192.168.1.100:5678/api/v1/workflows/$WORKFLOW_ID" \
  -H "X-N8N-API-KEY: $N8N_KEY" \
  -H "Content-Type: application/json" \
  -d '{"active": true}'
```

**Note on OPENCLAW_HOOKS_TOKEN in n8n:** The hooks token needs to be available to the HTTP Request node. Options:
1. Use n8n environment variable: set `OPENCLAW_HOOKS_TOKEN` in n8n's env via Coolify
2. Hardcode the token in the HTTP header (less ideal but works)
3. Use n8n credential (Header Auth) with the token value

Preferred: Set `OPENCLAW_HOOKS_TOKEN` as an n8n environment variable in Coolify, then reference it as `{{$env.OPENCLAW_HOOKS_TOKEN}}` in the node.

If the n8n API doesn't support all node parameters via JSON, create a simpler workflow via API and note the manual edits needed.
  </action>
  <verify>
    - Workflow appears in n8n UI at https://n8n.aakashe.org
    - Workflow is active (green toggle)
    - Error Trigger node is connected to HTTP Request node
  </verify>
  <done>Error handler workflow exists and is active in n8n.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>n8n error handler workflow created and activated. Now needs to be set as the Global Error Workflow.</what-built>
  <how-to-verify>
**Set as Global Error Workflow:**
1. Go to n8n UI: https://n8n.aakashe.org
2. Click the gear icon (bottom-left) -> Settings
3. Under "Workflow Settings" or "Error Workflow":
   - Set "Error Workflow" to "OpenClaw Error Handler"
4. Save

**Test the error trigger:**
1. Create a simple test workflow in n8n with a Code node that throws an error: `throw new Error("test error")`
2. Execute the test workflow manually
3. Check: did the Automation Supervisor session receive the error message?
   ```bash
   # Check via OpenClaw logs or direct API
   curl -s "http://192.168.1.100:18789/hooks/agent" \
     -H "Authorization: Bearer <HOOKS_TOKEN>" \
     -d '{"agentId": "automation-supervisor", "sessionKey": "hook:automation-supervisor", "message": "test ping"}' \
     -H "Content-Type: application/json"
   ```

Also verify the OPENCLAW_HOOKS_TOKEN is accessible to the n8n workflow (either as env var or hardcoded in the node).

Type "error-trigger-working" if the Supervisor receives the test error, or describe issues.
  </how-to-verify>
  <resume-signal>Type "error-trigger-working" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. n8n has an active "OpenClaw Error Handler" workflow
2. The workflow is set as the Global Error Workflow in n8n Settings
3. A deliberately failed test workflow triggers a POST to hook:automation-supervisor
4. The POST includes agentId, sessionKey, and error details
</verification>

<success_criteria>
- Error handler workflow is active in n8n
- Global Error Workflow is set to the error handler
- Test error fires and reaches the Automation Supervisor session
</success_criteria>

<output>
After completion, create `.planning/phases/08-the-organization-director-workforce/08-03-SUMMARY.md`
</output>
