---
phase: 08-the-organization-director-workforce
plan: 03
type: execute
wave: 3
depends_on: ["08-01"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "n8n has a Global Error Trigger workflow that fires when any workflow fails"
    - "The error workflow POSTs to OpenClaw hooks endpoint with agentId=automation-supervisor"
    - "The hook POST includes both agentId AND sessionKey (required for correct routing)"
    - "The error workflow itself does NOT trigger the global error handler (infinite loop prevention)"
  artifacts: []
  key_links:
    - from: "n8n Global Error Trigger"
      to: "http://192.168.1.100:18789/hooks/agent"
      via: "HTTP Request node with Bearer auth"
      pattern: "hook:automation-supervisor"
---

<objective>
Create the n8n Global Error Trigger workflow that routes all workflow failures to the Automation Supervisor.

Purpose: This is the entry point for the self-healing loop. When any n8n workflow fails, the error is automatically sent to the Automation Supervisor for diagnosis and repair. Without this, workflow failures go unnoticed.

Output: An active n8n workflow set as the Global Error Workflow in n8n Settings.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-the-organization-director-workforce/08-RESEARCH.md
@ARCHITECTURE_PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create n8n Global Error Handler workflow via API</name>
  <files></files>
  <action>
Use the n8n API to create the error handler workflow. The n8n instance is at http://192.168.1.100:5678 and the API key is stored in the container at /data/.openclaw/credentials/N8N_API_KEY.

Step 1: Get the N8N_API_KEY from the server:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec CONTAINER_NAME cat /data/.openclaw/credentials/N8N_API_KEY"
```

Step 2: Get the HOOKS_TOKEN from the container config:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec CONTAINER_NAME jq -r '.hooks.token' /data/.openclaw/openclaw.json"
```

Step 3: Create the workflow via n8n API. The workflow has 2 nodes:
- **Error Trigger** node: receives the error payload from n8n
- **HTTP Request** node: POSTs to OpenClaw hooks endpoint

```bash
curl -s -X POST "http://192.168.1.100:5678/api/v1/workflows" \
  -H "X-N8N-API-KEY: $N8N_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Global Error Handler → Automation Supervisor",
    "nodes": [
      {
        "parameters": {},
        "id": "error-trigger",
        "name": "Error Trigger",
        "type": "n8n-nodes-base.errorTrigger",
        "typeVersion": 1,
        "position": [250, 300]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "http://192.168.1.100:18789/hooks/agent",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Authorization",
                "value": "Bearer HOOKS_TOKEN_PLACEHOLDER"
              }
            ]
          },
          "sendBody": true,
          "specifyBody": "json",
          "jsonBody": "={{ JSON.stringify({ agentId: \"automation-supervisor\", sessionKey: \"hook:automation-supervisor\", message: `n8n workflow failed.\\n\\nWorkflow: ${$json.workflow?.name || \"unknown\"} (ID: ${$json.workflow?.id || \"unknown\"})\\nFailed node: ${$json.execution?.lastNodeExecuted || \"unknown\"}\\nError: ${$json.execution?.error?.message || \"no error message\"}\\nExecution URL: ${$json.execution?.url || \"not available\"}\\n\\nPlease diagnose and fix. Use n8n API to fetch workflow JSON: GET /api/v1/workflows/${$json.workflow?.id}`, name: \"n8n-error-trigger\", wakeMode: \"now\", deliver: false }) }}",
          "options": {
            "timeout": 30000
          }
        },
        "id": "http-request",
        "name": "POST to Automation Supervisor",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4.2,
        "position": [500, 300]
      }
    ],
    "connections": {
      "Error Trigger": {
        "main": [
          [
            {
              "node": "POST to Automation Supervisor",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "settings": {
      "executionOrder": "v1"
    },
    "active": true
  }'
```

IMPORTANT: Replace `HOOKS_TOKEN_PLACEHOLDER` with the actual hooks token retrieved in Step 2.

NOTE: The n8n API may not support setting this as the Global Error Workflow via API. If the API does not have this setting, Task 2 handles the manual step.

Step 4: Activate the workflow if not already active:
```bash
WORKFLOW_ID=$(curl -s "http://192.168.1.100:5678/api/v1/workflows" \
  -H "X-N8N-API-KEY: $N8N_API_KEY" | jq -r '.data[] | select(.name | contains("Global Error Handler")) | .id')

curl -s -X PATCH "http://192.168.1.100:5678/api/v1/workflows/$WORKFLOW_ID" \
  -H "X-N8N-API-KEY: $N8N_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"active": true}'
```

Step 5: Verify the workflow exists and is active:
```bash
curl -s "http://192.168.1.100:5678/api/v1/workflows" \
  -H "X-N8N-API-KEY: $N8N_API_KEY" | jq '.data[] | select(.name | contains("Global Error Handler")) | {id, name, active}'
```
  </action>
  <verify>
The workflow should appear in the n8n API response with `active: true`. Test by listing workflows:
```bash
curl -s "http://192.168.1.100:5678/api/v1/workflows" \
  -H "X-N8N-API-KEY: $N8N_API_KEY" | jq '.data[] | select(.name | contains("Global Error")) | {id, name, active}'
```
  </verify>
  <done>n8n has an active "Global Error Handler" workflow that POSTs to hook:automation-supervisor with agentId, sessionKey, and structured error message.</done>
</task>

<task type="auto">
  <name>Task 2: Set Global Error Workflow in n8n settings and test</name>
  <files></files>
  <action>
The Global Error Workflow setting in n8n must be configured. Try the API first, but if the API doesn't support it, a human action is REQUIRED before testing.

Step 1: Try setting via n8n owner settings API:
```bash
# Get the workflow ID first
WORKFLOW_ID=$(curl -s "http://192.168.1.100:5678/api/v1/workflows" \
  -H "X-N8N-API-KEY: $N8N_API_KEY" | jq -r '.data[] | select(.name | contains("Global Error Handler")) | .id')

# Try the settings API (may not exist in all n8n versions)
curl -s -X PATCH "http://192.168.1.100:5678/api/v1/settings" \
  -H "X-N8N-API-KEY: $N8N_API_KEY" \
  -H "Content-Type: application/json" \
  -d "{\"errorWorkflowId\": \"$WORKFLOW_ID\"}"
```

If the settings API approach fails (returns 404 or 403), this requires a human action. Output the following checkpoint message and STOP:

```
## CHECKPOINT: Human Action Required

The n8n API does not support setting the Global Error Workflow programmatically.

ACTION REQUIRED (takes 30 seconds):
1. Open n8n UI: http://192.168.1.100:5678
2. Go to Settings (gear icon, bottom-left)
3. Click "Workflows"
4. Find "Default Error Workflow"
5. Select "Global Error Handler → Automation Supervisor"
6. Click Save

Once done, reply "done" to continue with the test.
```

Do NOT proceed to Step 2 (testing) until the user confirms the setting is saved.

Step 2: Test with a deliberately broken workflow:
```bash
# Create a test workflow that will fail
TEST_WF=$(curl -s -X POST "http://192.168.1.100:5678/api/v1/workflows" \
  -H "X-N8N-API-KEY: $N8N_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "TEST: Deliberate Failure (delete me)",
    "nodes": [
      {
        "parameters": {},
        "id": "manual-trigger",
        "name": "Manual Trigger",
        "type": "n8n-nodes-base.manualTrigger",
        "typeVersion": 1,
        "position": [250, 300]
      },
      {
        "parameters": {
          "jsCode": "throw new Error(\"Deliberate test failure for Global Error Handler verification\");"
        },
        "id": "code-node",
        "name": "Deliberate Failure",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [500, 300]
      }
    ],
    "connections": {
      "Manual Trigger": {
        "main": [[{"node": "Deliberate Failure", "type": "main", "index": 0}]]
      }
    },
    "settings": {"executionOrder": "v1"}
  }')

TEST_WF_ID=$(echo $TEST_WF | jq -r '.id')
echo "Created test workflow: $TEST_WF_ID"

# Execute the test workflow (it will fail)
curl -s -X POST "http://192.168.1.100:5678/api/v1/workflows/$TEST_WF_ID/execute" \
  -H "X-N8N-API-KEY: $N8N_API_KEY"

# Wait for execution, then check if the error handler fired
sleep 5

# Check the automation-supervisor session for the error message
# (This requires the hooks endpoint to be working, which it is per Phase 5)

# Clean up test workflow
curl -s -X DELETE "http://192.168.1.100:5678/api/v1/workflows/$TEST_WF_ID" \
  -H "X-N8N-API-KEY: $N8N_API_KEY"
```

NOTE: If the Global Error Workflow setting could not be configured via API, document this in the summary and the user can set it via the n8n UI manually (Settings > Workflows > Default Error Workflow).
  </action>
  <verify>
After the test workflow fails, check that the automation-supervisor received the error:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec CONTAINER_NAME ls -la /data/.openclaw/agents/automation-supervisor/sessions/"
```
If sessions exist for automation-supervisor, the hook routed correctly.
  </verify>
  <done>n8n Global Error Handler workflow is active and confirmed as the default error workflow (either via API or user-confirmed via UI). Test failure confirms errors route to automation-supervisor hook session.</done>
</task>

</tasks>

<verification>
1. n8n API lists "Global Error Handler" workflow with active=true
2. The workflow's HTTP Request node POSTs to http://192.168.1.100:18789/hooks/agent with correct agentId and sessionKey
3. Test failure routes to automation-supervisor (session file created or message received)
</verification>

<success_criteria>
- n8n has an active Global Error Handler workflow
- Workflow failures POST to hook:automation-supervisor with agentId + sessionKey
- Error message includes workflow name, failed node, and error text
- Self-referential loop is prevented (n8n built-in)
</success_criteria>

<output>
After completion, create `.planning/phases/08-the-organization-director-workforce/08-03-SUMMARY.md`
</output>
