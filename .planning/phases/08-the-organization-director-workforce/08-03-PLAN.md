---
phase: 08-the-organization-director-workforce
plan: "03"
type: execute
wave: 2
depends_on: ["08-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "An n8n workflow named 'Error Handler — Automation Supervisor' exists and is active"
    - "The workflow has an Error Trigger node as its start"
    - "The workflow POSTs to http://192.168.1.100:18789/hooks/agent with agentId automation-supervisor and sessionKey hook:automation-supervisor"
    - "The workflow message includes workflow name, failed node name, and error message from the Error Trigger payload"
    - "Setting the workflow as Global Error Workflow in n8n Settings is documented (may require manual UI step)"
  artifacts:
    - path: "n8n workflow: Error Handler — Automation Supervisor"
      provides: "Global error routing from n8n to automation-supervisor hook session"
  key_links:
    - from: "n8n Error Trigger"
      to: "http://192.168.1.100:18789/hooks/agent"
      via: "HTTP Request node with Authorization: Bearer HOOKS_TOKEN"
      pattern: "hooks/agent"
    - from: "HTTP Request node payload"
      to: "automation-supervisor session"
      via: "agentId + sessionKey routing"
      pattern: "hook:automation-supervisor"
---

<objective>
Create the n8n Global Error Trigger workflow that routes n8n failures to the Automation Supervisor. This is the entry point for the self-healing loop: when any n8n workflow fails, the Automation Supervisor wakes up with error context, diagnoses the problem, and applies a fix.

Purpose: The Automation Supervisor's self-healing capability described in ARCHITECTURE_PLAN.md Section 3b requires a trigger. This workflow is that trigger.
Output: Active n8n workflow "Error Handler — Automation Supervisor" that fires on any n8n workflow failure.

Wave: 2 — parallel with 08-02. Depends on 08-01 (automation-supervisor must be in agents.list before the hook endpoint is useful).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-the-organization-director-workforce/08-CONTEXT.md
@.planning/phases/08-the-organization-director-workforce/08-RESEARCH.md
@.planning/phases/08-the-organization-director-workforce/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pre-flight check — verify automation-supervisor in agents.list and get HOOKS_TOKEN</name>
  <files></files>
  <action>
Before creating the n8n workflow, verify the prerequisites from 08-01 are in place. Run these checks from the Mac (not inside the container):

```bash
# Get container name
CONTAINER=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker ps --format '{{.Names}}' | grep openclaw | grep -v proxy | grep -v searxng | head -1")
echo "Container: $CONTAINER"

# Verify automation-supervisor is in agents.list
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER jq '[.agents.list[] | .id]' /data/.openclaw/openclaw.json"

# Get HOOKS_TOKEN
HOOKS_TOKEN=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER cat /data/.openclaw/credentials/HOOKS_TOKEN")
echo "HOOKS_TOKEN: $HOOKS_TOKEN"

# Test hook endpoint for automation-supervisor
curl -s -o /dev/null -w "%{http_code}" \
  -X POST "http://192.168.1.100:18789/hooks/agent" \
  -H "Authorization: Bearer $HOOKS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"agentId": "automation-supervisor", "sessionKey": "hook:automation-supervisor", "message": "Pre-flight check: automation-supervisor hook endpoint test."}'
# Expected: 200 or 202
```

Get the N8N_API_KEY for workflow creation:
```bash
N8N_API_KEY=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER cat /data/.openclaw/credentials/N8N_API_KEY")
echo "N8N_API_KEY acquired"
```

Stop and document the HOOKS_TOKEN and N8N_API_KEY values — needed for the next task.

**Do not proceed if:**
- automation-supervisor is NOT in agents.list → 08-01 must be deployed first
- Hook endpoint returns non-200 → investigate gateway logs before continuing
  </action>
  <verify>
```bash
# automation-supervisor hook returns 200/202
# HOOKS_TOKEN is non-empty
# N8N_API_KEY is non-empty
```
  </verify>
  <done>
- automation-supervisor confirmed in agents.list
- Hook POST to automation-supervisor returns 200 or 202
- HOOKS_TOKEN and N8N_API_KEY values captured for Task 2
  </done>
</task>

<task type="auto">
  <name>Task 2: Create n8n Error Handler workflow via n8n API</name>
  <files></files>
  <action>
Create the error handler workflow via the n8n REST API. The workflow has two nodes: Error Trigger (start) and HTTP Request (POST to OpenClaw hooks).

**Workflow JSON structure:**

The workflow POSTs to OpenClaw with a structured message containing the workflow name, failed node, error message, and execution URL. Per ARCHITECTURE_PLAN.md Section 3b and research (08-RESEARCH.md): include `agentId` AND `sessionKey` — without both, the message routes to default agent (main) instead of automation-supervisor.

**Create the workflow:**
```bash
N8N_API_KEY="<from task 1>"
HOOKS_TOKEN="<from task 1>"
GATEWAY_URL="http://192.168.1.100:18789"

curl -s -X POST "http://192.168.1.100:5678/api/v1/workflows" \
  -H "X-N8N-API-KEY: $N8N_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Error Handler — Automation Supervisor",
    "nodes": [
      {
        "id": "error-trigger",
        "name": "Error Trigger",
        "type": "n8n-nodes-base.errorTrigger",
        "typeVersion": 1,
        "position": [240, 300],
        "parameters": {}
      },
      {
        "id": "notify-supervisor",
        "name": "Notify Automation Supervisor",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 4,
        "position": [480, 300],
        "parameters": {
          "method": "POST",
          "url": "'"$GATEWAY_URL"'/hooks/agent",
          "authentication": "genericCredentialType",
          "genericAuthType": "httpHeaderAuth",
          "options": {},
          "sendHeaders": true,
          "headerParameters": {
            "parameters": [
              {
                "name": "Authorization",
                "value": "Bearer '"$HOOKS_TOKEN"'"
              },
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          },
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "agentId",
                "value": "automation-supervisor"
              },
              {
                "name": "sessionKey",
                "value": "hook:automation-supervisor"
              },
              {
                "name": "name",
                "value": "n8n-error-trigger"
              },
              {
                "name": "wakeMode",
                "value": "now"
              },
              {
                "name": "deliver",
                "value": false
              },
              {
                "name": "message",
                "value": "=n8n workflow failure detected.\n\nWorkflow: {{ $json.workflow.name }} (ID: {{ $json.workflow.id }})\nFailed node: {{ $json.execution.lastNodeExecuted }}\nError: {{ $json.execution.error.message }}\nExecution URL: {{ $json.execution.url }}\n\nDiagnose and repair. Record findings in memory/patterns/n8n-error-recovery.md. Notify main agent when resolved."
              }
            ]
          }
        }
      }
    ],
    "connections": {
      "Error Trigger": {
        "main": [
          [
            {
              "node": "Notify Automation Supervisor",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "settings": {
      "saveManualExecutions": true,
      "saveDataSuccessExecution": "all",
      "saveDataErrorExecution": "all"
    },
    "active": false
  }'
```

Capture the workflow ID from the response (it will be in `.id`).

**Activate the workflow:**
```bash
WORKFLOW_ID="<id from creation response>"
curl -s -X POST "http://192.168.1.100:5678/api/v1/workflows/$WORKFLOW_ID/activate" \
  -H "X-N8N-API-KEY: $N8N_API_KEY"
```

Expected: `{"active": true}` or similar.

**Verify it is active:**
```bash
curl -s "http://192.168.1.100:5678/api/v1/workflows/$WORKFLOW_ID" \
  -H "X-N8N-API-KEY: $N8N_API_KEY" | jq '{id: .id, name: .name, active: .active}'
```
  </action>
  <verify>
```bash
# Workflow exists and is active
curl -s "http://192.168.1.100:5678/api/v1/workflows?name=Error+Handler" \
  -H "X-N8N-API-KEY: $N8N_API_KEY" | jq '.data[] | {name, active, id}'
# Expected: active: true
```
  </verify>
  <done>
- Workflow "Error Handler — Automation Supervisor" exists in n8n
- Workflow is active (active: true in API response)
- Workflow has Error Trigger as start node
- Workflow HTTP Request node targets http://192.168.1.100:18789/hooks/agent with HOOKS_TOKEN auth
- Message payload includes agentId: automation-supervisor and sessionKey: hook:automation-supervisor
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
The n8n workflow "Error Handler — Automation Supervisor" has been created and activated via the n8n API. It routes any n8n workflow failure to the Automation Supervisor's session via the OpenClaw hooks endpoint.

Two things need manual verification:
1. Test the end-to-end flow by triggering a deliberate failure
2. Set this workflow as the Global Error Workflow in n8n Settings (the API may not support this setting — it may require the UI)
  </what-built>
  <how-to-verify>
**Step 1 — Set as Global Error Workflow (n8n UI):**

Open http://192.168.1.100:5678 in your browser.

Navigate to: Settings (left sidebar gear icon) -> Workflow Settings -> Error Workflow

Select "Error Handler — Automation Supervisor" from the dropdown. Save.

If you cannot find this setting in the UI, check the n8n version — the location may vary. Document what you found.

**Step 2 — Test the self-healing loop with a deliberate failure:**

Create a test workflow in n8n (via UI or API):
- Add an HTTP Request node pointing to `http://localhost:99999/invalid` (will fail immediately)
- Set it to run once manually
- Execute it — it should fail

Within 30-60 seconds, check the Automation Supervisor's session by sending a hook message:
```bash
HOOKS_TOKEN=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec \$(sudo docker ps --format '{{.Names}}' | grep openclaw | grep -v proxy | grep -v searxng | head -1) cat /data/.openclaw/credentials/HOOKS_TOKEN")

curl -s -X POST "http://192.168.1.100:18789/hooks/agent" \
  -H "Authorization: Bearer $HOOKS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"agentId": "automation-supervisor", "sessionKey": "hook:automation-supervisor", "message": "Status check: did you receive a recent n8n error notification? What was it?"}'
```

Expected response: The Supervisor confirms it received the error trigger message and describes the failure.

**Step 3 — Clean up the test workflow:**

Delete the deliberately broken test workflow in the n8n UI so it does not pollute the error log.

**Important note on infinite loop prevention:**
n8n does NOT trigger the error workflow for the error workflow itself — this is built-in behavior. The "Error Handler — Automation Supervisor" workflow will not fire if IT fails.
  </how-to-verify>
  <resume-signal>Type "n8n-wired" when the Global Error Workflow is set and the test confirms the Supervisor received the error notification. Or describe what failed.</resume-signal>
</task>

</tasks>

<verification>
After checkpoint approval:
- n8n API confirms workflow "Error Handler — Automation Supervisor" exists and `active: true`
- n8n Settings page shows this workflow as the Global Error Workflow
- Supervisor's session received and acknowledged the test error notification
- Test broken workflow has been deleted from n8n
</verification>

<success_criteria>
- Workflow exists in n8n, is active, named "Error Handler — Automation Supervisor"
- Workflow fires on n8n failures and POSTs to hook:automation-supervisor with agentId and sessionKey
- Global Error Workflow setting in n8n Settings points to this workflow
- End-to-end test: deliberate n8n failure -> Supervisor session receives the error notification
</success_criteria>

<output>
After completion, create `.planning/phases/08-the-organization-director-workforce/08-03-SUMMARY.md`

Include:
- Workflow ID and whether activation succeeded via API
- Whether Global Error Workflow was settable via API or required UI (document the finding)
- End-to-end test result: did the Supervisor receive the error notification?
- n8n Error Trigger payload fields that were actually present (verify against 08-RESEARCH.md expected schema)
- Any payload field adjustments needed (e.g., if execution.url was empty)
</output>
