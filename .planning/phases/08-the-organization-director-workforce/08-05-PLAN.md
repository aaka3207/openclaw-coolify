---
phase: 08-the-organization-director-workforce
plan: 05
type: execute
wave: 5
depends_on: ["08-01", "08-02", "08-03", "08-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Automation Supervisor exists and responds to hook messages"
    - "Budget CFO and Business Researcher exist and respond to hook messages"
    - "COMPANY_MEMORY.md is searchable by all agents via memory_search"
    - "n8n error trigger fires and reaches the Automation Supervisor"
    - "Claude Code is executable from within the container"
    - "Weekly retrospective cron is configured"
  artifacts: []
  key_links:
    - from: "n8n error trigger"
      to: "hook:automation-supervisor"
      via: "HTTP POST with agentId + sessionKey"
      pattern: "automation-supervisor"
    - from: "agents.defaults.memorySearch.extraPaths"
      to: "COMPANY_MEMORY.md"
      via: "built-in memorySearch indexing"
      pattern: "COMPANY_MEMORY"
---

<objective>
End-to-end verification of the entire Organization infrastructure after deploy.

Purpose: Confirms all Phase 8 components work together: Director registration, hook routing, n8n error loop, Claude Code, cross-agent memory, and institutional memory cron.

Output: Verified working Organization infrastructure ready for operational use.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@ARCHITECTURE_PLAN.md
@ARCHITECTURE_REFINEMENT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy and verify infrastructure</name>
  <files></files>
  <action>
**Step 1: Deploy** (git push triggers webhook -> Coolify rebuild)

If not already deployed from 08-01, push the changes:
```bash
git push origin main
```
Wait for Coolify deploy to complete. Monitor via Coolify dashboard or API.

**Step 2: Verify Automation Supervisor registration**
```bash
CONTAINER=$(sudo docker ps --format '{{.Names}}' | grep openclaw | head -1)

# Check agents.list
sudo docker exec "$CONTAINER" jq '.agents.list[] | {id, name, workspace}' /data/.openclaw/openclaw.json

# Check Supervisor workspace
sudo docker exec "$CONTAINER" ls -la /data/openclaw-workspace/agents/automation-supervisor/
sudo docker exec "$CONTAINER" head -5 /data/openclaw-workspace/agents/automation-supervisor/SOUL.md
```

**Step 3: Verify memorySearch extraPaths**
```bash
sudo docker exec "$CONTAINER" jq '.agents.defaults.memorySearch.extraPaths' /data/.openclaw/openclaw.json
# Expected: ["/data/openclaw-workspace/COMPANY_MEMORY.md"]
```

**Step 4: Verify COMPANY_MEMORY.md exists**
```bash
sudo docker exec "$CONTAINER" cat /data/openclaw-workspace/COMPANY_MEMORY.md
```

**Step 5: Verify weekly retrospective cron**
```bash
sudo docker exec "$CONTAINER" jq '.cron.jobs[] | select(.name == "weekly-retrospective")' /data/.openclaw/openclaw.json
```

**Step 6: Verify add-director.sh exists**
```bash
sudo docker exec "$CONTAINER" ls -la /app/scripts/add-director.sh
sudo docker exec "$CONTAINER" bash /app/scripts/add-director.sh --help 2>&1 | head -5
```

**Step 7: Verify Claude Code**
```bash
sudo docker exec "$CONTAINER" bash -c 'claude --version 2>/dev/null || /data/.claude/bin/claude --version 2>/dev/null || /data/.local/bin/claude --version 2>/dev/null || echo "Claude Code NOT found"'
```

**Step 8: Test hook routing to Automation Supervisor**
```bash
HOOKS_TOKEN=$(sudo docker exec "$CONTAINER" jq -r '.hooks.token' /data/.openclaw/openclaw.json)

curl -s -w "\n%{http_code}" "http://192.168.1.100:18789/hooks/agent" \
  -H "Authorization: Bearer $HOOKS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"agentId": "automation-supervisor", "sessionKey": "hook:automation-supervisor", "message": "E2E test: confirm you are the Automation Supervisor. Report your capabilities.", "wakeMode": "now"}'
# Expected: 200

# Also test that all 3 Directors are reachable
for agent in automation-supervisor budget-cfo business-researcher; do
  echo "Testing $agent..."
  curl -s -o /dev/null -w "%{http_code}" "http://192.168.1.100:18789/hooks/agent" \
    -H "Authorization: Bearer $HOOKS_TOKEN" \
    -H "Content-Type: application/json" \
    -d "{\"agentId\": \"$agent\", \"sessionKey\": \"hook:$agent\", \"message\": \"ping\", \"wakeMode\": \"now\"}"
  echo ""
done
```

**Step 9: Test memory_search for COMPANY_MEMORY.md**

Send a message to the Automation Supervisor asking it to search for company memory:
```bash
curl -s "http://192.168.1.100:18789/hooks/agent" \
  -H "Authorization: Bearer $HOOKS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"agentId": "automation-supervisor", "sessionKey": "hook:automation-supervisor", "message": "Run memory_search for \"company memory\" and report what you find.", "wakeMode": "now"}'
```

**Step 10: Test n8n error trigger (if 08-03 is complete)**

Create a test workflow in n8n that deliberately fails, execute it, and verify the Automation Supervisor receives the error notification. Check gateway logs for the incoming hook POST.
  </action>
  <verify>
    All 10 steps pass without errors.
  </verify>
  <done>
    All Phase 8 infrastructure is deployed, connected, and working.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Full Organization infrastructure: 3 Directors, hook routing, n8n error trigger, Claude Code, cross-agent memory, weekly cron.</what-built>
  <how-to-verify>
**Checklist â€” verify each:**

1. Open the OpenClaw Control UI (http://192.168.1.100:18789)
   - Confirm you can see the Automation Supervisor agent in the agents list
   - Send a test message to the Supervisor and verify it responds

2. Check Director routing:
   - Send a message to Budget CFO via hook and verify response
   - Send a message to Business Researcher via hook and verify response

3. Verify n8n error loop (if 08-03 done):
   - Deliberately fail an n8n workflow
   - Check that the Automation Supervisor receives the error

4. Verify Claude Code (if 08-02 done):
   - Ask the Automation Supervisor to run a simple Claude Code task

5. Check COMPANY_MEMORY.md:
   - Ask any Director to `memory_search "company memory"` and confirm results

6. Confirm NO workflow-worker in agents.list:
   - `jq '.agents.list[].id' /data/.openclaw/openclaw.json` should show: main, automation-supervisor, budget-cfo, business-researcher (4 agents, not 5)

Type "phase-8-verified" if all checks pass, or describe what failed.
  </how-to-verify>
  <resume-signal>Type "phase-8-verified" or describe issues</resume-signal>
</task>

</tasks>

<verification>
End-to-end:
1. Gateway starts with all agents registered
2. Each Director responds to hook POSTs
3. n8n error -> Automation Supervisor session
4. Claude Code executable from container
5. COMPANY_MEMORY.md searchable by all agents
6. Weekly retrospective cron configured
7. No workflow-worker in agents.list (ephemeral via sessions_spawn)
8. add-director.sh can create new Directors dynamically
</verification>

<success_criteria>
- All 3 Directors (Automation Supervisor, Budget CFO, Business Researcher) respond to hooks
- n8n error trigger reaches Automation Supervisor
- Claude Code is installed and authenticated
- COMPANY_MEMORY.md is indexed and searchable
- Weekly retrospective cron is scheduled
- The Organization is ready for operational use
</success_criteria>

<output>
After completion, create `.planning/phases/08-the-organization-director-workforce/08-05-SUMMARY.md`
</output>
