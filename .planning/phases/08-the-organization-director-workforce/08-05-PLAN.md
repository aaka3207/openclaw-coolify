---
phase: 08-the-organization-director-workforce
plan: 05
type: execute
wave: 5
depends_on: ["08-01", "08-02", "08-03", "08-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "All 4 Director agents appear in the running container's agents.list"
    - "Each Director's workspace directory exists with SOUL.md and memory/patterns/"
    - "A hook POST to each Director's sessionKey reaches the correct agent (not main)"
    - "n8n error trigger routes to automation-supervisor"
    - "Claude Code CLI works inside the container (authenticated)"
    - "QMD collections are configured and indexing"
    - "COMPANY_MEMORY.md exists and is searchable"
    - "No existing functionality is broken (sub-agents, hooks, memorySearch)"
  artifacts: []
  key_links:
    - from: "n8n Global Error Trigger"
      to: "hook:automation-supervisor"
      via: "HTTP POST with agentId + sessionKey"
      pattern: "automation-supervisor"
    - from: "QMD collections"
      to: "All agents via MCP"
      via: "mcp.servers.qmd in openclaw.json"
      pattern: "qmd"
---

<objective>
End-to-end verification of The Organization infrastructure. Deploy changes, verify all Directors are registered, test hook routing, confirm n8n error trigger, validate Claude Code auth, and check QMD collections.

Purpose: This is the final verification that all Phase 8 components work together. Every Director must be reachable, the self-healing loop must function, and no existing functionality (sub-agents, hooks, memorySearch) can be broken.

Output: Verified working Organization infrastructure with all Directors registered and reachable.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-the-organization-director-workforce/08-01-SUMMARY.md
@.planning/phases/08-the-organization-director-workforce/08-02-SUMMARY.md
@.planning/phases/08-the-organization-director-workforce/08-03-SUMMARY.md
@.planning/phases/08-the-organization-director-workforce/08-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy bootstrap.sh changes and verify gateway starts</name>
  <files></files>
  <action>
Push the bootstrap.sh changes to trigger a Coolify webhook deploy (git push, NOT API deploy — API deploy forces full rebuild which takes 2+ hours on HDD).

```bash
git add scripts/bootstrap.sh
git commit -m "feat(08): register Director agents, seed workspaces, QMD collections, COMPANY_MEMORY"
git push origin main
```

Wait for Coolify to pick up the deploy (~5 min for code-only changes with cached layers).

Then verify the gateway started successfully:
```bash
# Check container is running
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker ps --filter 'name=openclaw' --format '{{.Names}} {{.Status}}'"

# Check gateway health
curl -s -o /dev/null -w '%{http_code}' http://192.168.1.100:18789/health
```

Expected: Container running, health endpoint returns 200.

If the gateway fails to start, check logs:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker logs --tail 100 CONTAINER_NAME"
```
  </action>
  <verify>
Gateway returns 200 on health check. Container status shows "Up" and "healthy".
  </verify>
  <done>Gateway is running with updated bootstrap.sh. All new patches applied successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Verify Director agents registered and workspaces seeded</name>
  <files></files>
  <action>
Check the running container's config and filesystem:

Step 1: Verify agents.list contains all Directors:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec CONTAINER_NAME jq '.agents.list[] | {id, name, workspace}' /data/.openclaw/openclaw.json"
```
Expected: 6 agents (main, n8n-specialist, automation-supervisor, budget-cfo, business-researcher, workflow-worker).

Step 2: Verify workspace directories exist:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec CONTAINER_NAME bash -c 'for d in automation-supervisor budget-cfo business-researcher workflow-worker; do echo \"\$d:\"; ls /data/openclaw-workspace/agents/\$d/; done'"
```
Expected: Each directory has SOUL.md, AGENTS.md (except possibly workflow-worker), memory/patterns/.

Step 3: Verify Supervisor-specific files:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec CONTAINER_NAME ls /data/openclaw-workspace/agents/automation-supervisor/memory/schemas/capabilities.md /data/openclaw-workspace/agents/automation-supervisor/memory/SYSTEM_HEALTH.md"
```

Step 4: Verify COMPANY_MEMORY.md:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec CONTAINER_NAME head -5 /data/openclaw-workspace/COMPANY_MEMORY.md"
```

Step 5: Verify QMD MCP server is in config:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec CONTAINER_NAME jq '.mcp.servers.qmd' /data/.openclaw/openclaw.json"
```

Step 6: Verify existing config is intact (safety check):
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec CONTAINER_NAME jq '{mode: .gateway.mode, remote_url: .gateway.remote.url, useAccessGroups: .commands.useAccessGroups, hooks_enabled: .hooks.enabled, hooks_sessionKey: .hooks.allowRequestSessionKey}' /data/.openclaw/openclaw.json"
```
Expected: `mode: "remote"`, `remote_url: "ws://127.0.0.1:18789"`, `useAccessGroups: false`, `hooks_enabled: true`, `hooks_sessionKey: true`.
  </action>
  <verify>All 6 steps produce expected output. No existing config values changed.</verify>
  <done>All Directors registered in agents.list. Workspaces seeded. Existing config intact.</done>
</task>

<task type="auto">
  <name>Task 3: Test hook routing to each Director</name>
  <files></files>
  <action>
Send a test hook POST to each Director and verify the message is received by the correct agent (not main).

Get the hooks token:
```bash
HOOKS_TOKEN=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec CONTAINER_NAME jq -r '.hooks.token' /data/.openclaw/openclaw.json")
```

Send test messages to each Director:
```bash
for DIRECTOR in automation-supervisor budget-cfo business-researcher; do
  echo "Testing $DIRECTOR..."
  HTTP_CODE=$(curl -s -o /tmp/hook-response-${DIRECTOR}.json -w '%{http_code}' \
    -X POST "http://192.168.1.100:18789/hooks/agent" \
    -H "Authorization: Bearer $HOOKS_TOKEN" \
    -H "Content-Type: application/json" \
    -d "{
      \"agentId\": \"${DIRECTOR}\",
      \"sessionKey\": \"hook:${DIRECTOR}\",
      \"message\": \"Phase 8 verification test. Reply with your agent id and workspace path. This is a one-time test message.\",
      \"name\": \"phase8-test\",
      \"wakeMode\": \"now\",
      \"deliver\": false
    }")
  echo "  $DIRECTOR: HTTP $HTTP_CODE"
  cat /tmp/hook-response-${DIRECTOR}.json | head -5
  echo ""
done
```

Expected: Each request returns HTTP 200 (accepted). The response may include a session ID or acknowledgment.

IMPORTANT: Include both `agentId` AND `sessionKey` in every POST (per user decision — required for correct routing).

Verify sessions were created:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec CONTAINER_NAME bash -c 'for d in automation-supervisor budget-cfo business-researcher; do echo \"\$d sessions:\"; ls /data/.openclaw/agents/\$d/sessions/ 2>/dev/null || echo \"  (no session dir yet)\"; done'"
```
  </action>
  <verify>
All 3 Director hooks return HTTP 200. Session directories are created for each Director under /data/.openclaw/agents/{id}/sessions/.
  </verify>
  <done>Hook routing works for all 3 Directors. Messages reach the correct agent (not main).</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Human verification of complete Organization infrastructure</name>
  <files></files>
  <action>
Present the verification checklist to the user and wait for confirmation that The Organization infrastructure is working end-to-end.
  </action>
  <verify>User confirms all checks pass or reports issues to fix.</verify>
  <done>User confirms Phase 8 infrastructure is operational.</done>
  <what-built>Complete Organization infrastructure: 4 Directors registered, workspaces seeded, n8n error trigger wired, QMD collections configured, COMPANY_MEMORY.md created, Claude Code installed.</what-built>
  <how-to-verify>
**Quick verification checklist:**

1. Open http://192.168.1.100:18789 in browser -- gateway should be accessible
2. Check the automated test results above -- all Directors should show HTTP 200
3. If you set the n8n Global Error Workflow in the UI (Settings > Workflows > Default Error Workflow), confirm it points to "Global Error Handler -> Automation Supervisor"

**If Claude Code auth was completed in 08-02:**
4. Verify Claude Code still works:
```bash
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec CONTAINER_NAME bash -c 'claude -p \"say hello\" --dangerously-skip-permissions --max-turns 1 --output-format json'"
```

**Optional deeper test -- send yourself a message via the Automation Supervisor:**
```bash
curl -X POST "http://192.168.1.100:18789/hooks/agent" \
  -H "Authorization: Bearer HOOKS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "agentId": "automation-supervisor",
    "sessionKey": "hook:automation-supervisor",
    "message": "Report your identity: what is your name, your workspace path, and what tools are available to you?",
    "name": "identity-check",
    "wakeMode": "now",
    "deliver": false
  }'
```

The Supervisor should respond with its SOUL.md identity and workspace.
  </how-to-verify>
  <resume-signal>Type "phase 8 verified" if everything checks out, or describe issues to fix.</resume-signal>
</task>

</tasks>

<verification>
1. Gateway running and healthy after deploy
2. All 4 Directors in agents.list (+ main + n8n-specialist = 6 total)
3. Each Director workspace has SOUL.md, memory/patterns/
4. Supervisor has memory/schemas/capabilities.md and memory/SYSTEM_HEALTH.md
5. COMPANY_MEMORY.md exists in main workspace
6. QMD MCP server in config
7. Hook routing works for all 3 persistent Directors
8. Existing config values unchanged (gateway.mode, remote.url, useAccessGroups, hooks)
9. Claude Code installed and authenticated (if 08-02 completed)
10. n8n Global Error Handler workflow active
</verification>

<success_criteria>
- All automated checks pass
- User confirms gateway accessible and Directors respond to hook messages
- No regressions in existing functionality (sub-agents, hooks, memorySearch still work)
- The Organization is operational
</success_criteria>

<output>
After completion, create `.planning/phases/08-the-organization-director-workforce/08-05-SUMMARY.md`
</output>
