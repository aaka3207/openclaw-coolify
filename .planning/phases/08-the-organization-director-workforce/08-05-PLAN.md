---
phase: 08-the-organization-director-workforce
plan: "05"
type: execute
wave: 4
depends_on: ["08-01", "08-02", "08-03", "08-04"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "agents.list has exactly 4 entries: main, automation-supervisor, budget-cfo, business-researcher"
    - "All 3 Director hook endpoints return 200 or 202"
    - "n8n error trigger sends to automation-supervisor and supervisor responds coherently"
    - "Claude Code CLI responds headlessly with ANTHROPIC_API_KEY from credential file"
    - "add-director.sh creates a new test Director live, gateway accepts its hook endpoint, then Director is removed"
    - "COMPANY_MEMORY.md is in main workspace and indexed (memory_search returns results)"
    - "No QMD references in any deployed Director SOUL.md"
    - "workflow-worker is NOT in agents.list"
  artifacts:
    - path: "/data/openclaw-workspace/agents/automation-supervisor/SOUL.md"
      provides: "Deployed Supervisor SOUL.md with memory_search and claude -p guidance"
      contains: "memory_search"
    - path: "/data/openclaw-workspace/agents/budget-cfo/SOUL.md"
      provides: "Deployed CFO SOUL.md with financial domain"
    - path: "/data/openclaw-workspace/agents/business-researcher/SOUL.md"
      provides: "Deployed BR SOUL.md with research domain"
  key_links:
    - from: "n8n Global Error Trigger"
      to: "automation-supervisor session"
      via: "HTTP POST to /hooks/agent with agentId + sessionKey"
      pattern: "hook:automation-supervisor"
    - from: "automation-supervisor SOUL.md"
      to: "/data/.local/bin/claude"
      via: "ANTHROPIC_API_KEY from credential file"
      pattern: "credentials/ANTHROPIC_API_KEY"
    - from: "add-director.sh"
      to: "agents.list"
      via: "chmod 644 -> jq -> chmod 444 -> SIGHUP"
      pattern: "agents.list"
---

<objective>
End-to-end verification of the complete Phase 8 Director workforce. This plan runs a structured test suite against all infrastructure created in plans 01-04, documents open question resolutions, and confirms the system is ready for autonomous operation.

Purpose: Every plan could have worked individually but failed to integrate. This plan proves the full system works end-to-end: Directors receive work, Supervisor can execute via Claude Code, n8n errors route correctly, and add-director.sh lifecycle works live.
Output: Verified, documented Director workforce ready for autonomous operation. Phase 8 complete.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-the-organization-director-workforce/08-01-SUMMARY.md
@.planning/phases/08-the-organization-director-workforce/08-02-SUMMARY.md
@.planning/phases/08-the-organization-director-workforce/08-03-SUMMARY.md
@.planning/phases/08-the-organization-director-workforce/08-04-SUMMARY.md
@ARCHITECTURE_PLAN.md
@ARCHITECTURE_REFINEMENT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Automated verification suite — agents.list count, hook endpoints, credential files, workspace integrity</name>
  <files></files>
  <action>
Run the full automated verification suite. All checks must pass before proceeding to human verification. Execute from Mac:

```bash
# Get container and HOOKS_TOKEN
CONTAINER=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker ps --format '{{.Names}}' | grep openclaw | grep -v proxy | grep -v searxng | head -1")

HOOKS_TOKEN=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER cat /data/.openclaw/credentials/HOOKS_TOKEN")

echo "=== 1. AGENTS.LIST STATE ==="
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER jq '{count: (.agents.list | length), ids: [.agents.list[].id]}' /data/.openclaw/openclaw.json"
# PASS: count = 4, ids = ["main", "automation-supervisor", "budget-cfo", "business-researcher"]
# FAIL: count != 4, or workflow-worker present, or any Director missing

echo "=== 2. NO WORKFLOW-WORKER ==="
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER jq '.agents.list[] | select(.id == \"workflow-worker\")' /data/.openclaw/openclaw.json"
# PASS: empty output (no workflow-worker)
# FAIL: non-empty output

echo "=== 3. DIRECTOR WORKSPACES ==="
for AGENT in automation-supervisor budget-cfo business-researcher; do
  sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
    "sudo docker exec $CONTAINER ls /data/openclaw-workspace/agents/$AGENT/ 2>&1"
  echo "^ $AGENT workspace"
done
# PASS: SOUL.md, HEARTBEAT.md, AGENTS.md, memory/ in each workspace

echo "=== 4. NO QMD IN SOUL.MD FILES ==="
for AGENT in automation-supervisor budget-cfo business-researcher; do
  RESULT=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
    "sudo docker exec $CONTAINER grep -i 'qmd' /data/openclaw-workspace/agents/$AGENT/SOUL.md 2>/dev/null || echo QMD_FREE")
  echo "$AGENT: $RESULT"
done
# PASS: all print QMD_FREE

echo "=== 5. SESSION MODEL LANGUAGE CHECK ==="
for AGENT in automation-supervisor budget-cfo business-researcher; do
  RESULT=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
    "sudo docker exec $CONTAINER grep -i 'check your session context\|session context first' /data/openclaw-workspace/agents/$AGENT/SOUL.md 2>/dev/null | head -1 || echo MISSING")
  echo "$AGENT: $RESULT"
done
# PASS: each prints the "check your session context" line
# FAIL: prints MISSING

echo "=== 6. CREDENTIAL FILES ==="
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER ls -la /data/.openclaw/credentials/"
# PASS: HOOKS_TOKEN, N8N_API_KEY, ANTHROPIC_API_KEY all present

echo "=== 7. COMPANY_MEMORY.MD AND EXTRAPATHS ==="
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER bash -c 'ls /data/openclaw-workspace/COMPANY_MEMORY.md && jq .agents.defaults.memorySearch.extraPaths /data/.openclaw/openclaw.json'"
# PASS: file exists, extraPaths contains COMPANY_MEMORY.md path

echo "=== 8. CLAUDE CODE CLI ==="
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER /data/.local/bin/claude --version 2>&1 || echo MISSING"
# PASS: version string
# FAIL: MISSING or command not found

echo "=== 9. HOOK ENDPOINT TESTS ==="
for AGENT in automation-supervisor budget-cfo business-researcher; do
  STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
    -X POST "http://192.168.1.100:18789/hooks/agent" \
    -H "Authorization: Bearer $HOOKS_TOKEN" \
    -H "Content-Type: application/json" \
    -d "{\"agentId\": \"$AGENT\", \"sessionKey\": \"hook:$AGENT\", \"message\": \"Verification ping from 08-05.\"}" \
    --max-time 15)
  echo "$AGENT hook: HTTP $STATUS"
done
# PASS: all return 200 or 202

echo "=== 10. N8N ERROR WORKFLOW ACTIVE ==="
N8N_API_KEY=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER cat /data/.openclaw/credentials/N8N_API_KEY")
curl -s "http://192.168.1.100:5678/api/v1/workflows" \
  -H "X-N8N-API-KEY: $N8N_API_KEY" | jq '.data[] | select(.name | contains("Error Handler")) | {name, active}'
# PASS: active: true
```

Document every check result. Any FAIL requires investigation and fix before proceeding to Task 2.
  </action>
  <verify>
All 10 checks return PASS. Document any failures encountered and their resolutions.
  </verify>
  <done>
- agents.list count = 4 (no more, no less)
- workflow-worker NOT in agents.list
- All 3 Director workspaces contain SOUL.md, HEARTBEAT.md, AGENTS.md, memory/
- No QMD references in any deployed SOUL.md
- All 3 SOUL.md files contain "check your session context" language
- credential files exist: HOOKS_TOKEN, N8N_API_KEY, ANTHROPIC_API_KEY
- COMPANY_MEMORY.md exists and appears in extraPaths
- claude --version returns a version string
- All 3 Director hook endpoints return 200 or 202
- n8n "Error Handler" workflow is active
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
All automated checks in Task 1 have passed. The Director workforce is structurally complete.

This checkpoint verifies 4 behavioral end-to-end flows that require human observation:
1. Automation Supervisor receives and responds to a simulated n8n error
2. Claude Code CLI runs headlessly under Automation Supervisor context
3. add-director.sh lifecycle works live (create test Director, verify, remove)
4. Director-to-Director communication works (Budget CFO sends message to Business Researcher)
  </what-built>
  <how-to-verify>
**Test A — Self-healing loop (simulate n8n error):**

Manually trigger the n8n Error Handler by creating and running a deliberately broken workflow in n8n UI:
1. Create a new workflow in n8n with a single "HTTP Request" node pointing to `http://localhost:99999` (invalid)
2. Run it manually — it will fail immediately
3. Check whether Automation Supervisor received the error by asking it:

```bash
HOOKS_TOKEN=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec \$(sudo docker ps --format '{{.Names}}' | grep openclaw | grep -v proxy | grep -v searxng | head -1) cat /data/.openclaw/credentials/HOOKS_TOKEN")

curl -X POST "http://192.168.1.100:18789/hooks/agent" \
  -H "Authorization: Bearer $HOOKS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"agentId": "automation-supervisor", "sessionKey": "hook:automation-supervisor", "message": "Status check: did you receive an n8n error notification in the last 2 minutes? Describe what it said."}'
```

PASS: Supervisor confirms it received the error trigger and describes the workflow name and error.
FAIL: Supervisor says it has no recent error notification.

After testing, delete the broken test workflow from n8n UI.

**Test B — Claude Code headless invocation:**

```bash
CONTAINER=$(sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker ps --format '{{.Names}}' | grep openclaw | grep -v proxy | grep -v searxng | head -1")

sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER bash -c '
    ANTHROPIC_API_KEY=\"\$(cat /data/.openclaw/credentials/ANTHROPIC_API_KEY)\" \
    /data/.local/bin/claude -p \"Say exactly: CLAUDE_CODE_WORKING\" \
    --dangerously-skip-permissions \
    --max-turns 1 \
    --output-format json \
    --no-session-persistence
  '"
```

PASS: JSON output contains "CLAUDE_CODE_WORKING". Exit code 0.
FAIL: Auth error, command not found, or non-zero exit.

**Test C — add-director.sh live lifecycle (create, verify, clean up):**

```bash
# Create test Director
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER bash /app/scripts/add-director.sh test-director 'Test Director' 'openrouter/anthropic/claude-haiku-4-5'"

# Verify hook responds
STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
  -X POST "http://192.168.1.100:18789/hooks/agent" \
  -H "Authorization: Bearer $HOOKS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"agentId": "test-director", "sessionKey": "hook:test-director", "message": "Test Director online check."}' \
  --max-time 15)
echo "test-director hook: HTTP $STATUS"
# PASS: 200 or 202

# Verify idempotency (run add-director.sh again for same id)
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER bash /app/scripts/add-director.sh test-director 'Test Director' 'openrouter/anthropic/claude-haiku-4-5' 2>&1"
# PASS: prints "already registered" and exits 0

# Clean up: remove test-director from agents.list
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100 \
  "sudo docker exec $CONTAINER bash -c \"
    chmod 644 /data/.openclaw/openclaw.json
    jq 'del(.agents.list[] | select(.id == \\\"test-director\\\"))' /data/.openclaw/openclaw.json > /tmp/cfg.tmp && mv /tmp/cfg.tmp /data/.openclaw/openclaw.json
    chmod 444 /data/.openclaw/openclaw.json
    echo Removed test-director from agents.list
    jq '[.agents.list[] | .id]' /data/.openclaw/openclaw.json
  \""
# PASS: agents.list back to 4 entries: main, automation-supervisor, budget-cfo, business-researcher
```

Note: test-director workspace at `/data/openclaw-workspace/agents/test-director/` can be left (harmless, no memory accumulated).

**Test D — Director-to-Director communication:**

Send a message to Budget CFO asking it to send a message to Business Researcher:

```bash
curl -X POST "http://192.168.1.100:18789/hooks/agent" \
  -H "Authorization: Bearer $HOOKS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"agentId": "budget-cfo", "sessionKey": "hook:budget-cfo", "message": "Please send a brief test message to the Business Researcher via curl (use the HOOKS_TOKEN from /data/.openclaw/credentials/HOOKS_TOKEN). Confirm when done."}'
```

Wait ~30 seconds, then check Business Researcher received it:
```bash
curl -X POST "http://192.168.1.100:18789/hooks/agent" \
  -H "Authorization: Bearer $HOOKS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"agentId": "business-researcher", "sessionKey": "hook:business-researcher", "message": "Did you receive a message from the Budget CFO recently? What did it say?"}'
```

PASS: Business Researcher confirms it received a message from Budget CFO.
FAIL: Business Researcher says it has no recent message. (Investigate whether CFO executed the curl correctly.)

**Document open questions from prior plans:**

Review 08-04-SUMMARY.md for:
- SIGHUP finding: does it reload config?
- MEMORY.md finding: auto-loaded in hook sessions?

These should already be documented. Confirm they are in the summary.
  </how-to-verify>
  <resume-signal>Type "phase-8-complete" when all 4 tests pass (A, B, C, D). Include any caveats or partial failures with explanations. Or describe blocking issues.</resume-signal>
</task>

</tasks>

<verification>
Phase 8 is complete when:
- All 10 automated checks in Task 1 pass
- Test A: n8n error routes to Supervisor and Supervisor acknowledges it
- Test B: Claude Code CLI runs headlessly and outputs expected text
- Test C: add-director.sh creates a live Director, idempotency confirmed, test Director cleaned up
- Test D: Director-to-Director curl communication confirmed working
- agents.list final count = 4 (after test-director cleanup)
- Open questions from ARCHITECTURE_REFINEMENT.md Section 12 documented in summaries
</verification>

<success_criteria>
- agents.list has exactly 4 entries: main, automation-supervisor, budget-cfo, business-researcher
- workflow-worker is NOT in agents.list
- All Director hook endpoints return 200/202
- n8n self-healing loop is end-to-end verified (error -> Supervisor receives and responds)
- Claude Code CLI works headlessly with ANTHROPIC_API_KEY from credential file
- add-director.sh lifecycle works: create, verify, idempotency-check, cleanup
- Director-to-Director communication works
- No QMD references in any deployed SOUL.md
- Open questions from ARCHITECTURE_REFINEMENT.md Section 12 answered and documented
</success_criteria>

<output>
After completion, create `.planning/phases/08-the-organization-director-workforce/08-05-SUMMARY.md`

Include:
- Final agents.list state (exact IDs)
- Results of all 10 automated checks (pass/fail)
- Results of all 4 behavioral tests (A, B, C, D)
- Consolidated answers to open questions:
  - MEMORY.md auto-loaded in hook sessions? (yes/no + evidence)
  - SIGHUP reloads gateway config? (yes/no + what works)
  - File-based cron (cron/ subdirectory) works? (yes/no + what works)
- Any issues discovered and fixed during verification
- State of Phase 8: COMPLETE or BLOCKED (with blockers listed)

Also update `.planning/STATE.md`:
- Phase 8 status: COMPLETE
- Note the open question resolutions (SIGHUP, MEMORY.md, cron)
- Update progress percentage
</output>
