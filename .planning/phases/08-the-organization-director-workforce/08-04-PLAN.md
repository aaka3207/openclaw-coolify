---
phase: 08-the-organization-director-workforce
plan: 04
type: execute
wave: 4
depends_on: ["08-01"]
files_modified:
  - scripts/bootstrap.sh
autonomous: true

must_haves:
  truths:
    - "QMD is configured with named collections for cross-agent memory search"
    - "QMD is available as an MCP server tool for all agents"
    - "COMPANY_MEMORY.md exists in main workspace"
    - "Weekly cron job updates COMPANY_MEMORY.md via OpenClaw native cron"
    - "QMD indexing runs in background (does not block gateway startup)"
  artifacts:
    - path: "scripts/bootstrap.sh"
      provides: "QMD collection setup + MCP config + COMPANY_MEMORY.md seeding"
      contains: "qmd collection"
  key_links:
    - from: "scripts/bootstrap.sh"
      to: "/data/.bun/bin/qmd"
      via: "QMD CLI commands for collection setup"
      pattern: "qmd.*collection"
    - from: "scripts/bootstrap.sh"
      to: "openclaw.json mcp.servers.qmd"
      via: "jq patch adding MCP server"
      pattern: "mcp.*servers.*qmd"
---

<objective>
Configure QMD multi-collection memory, add QMD as MCP server for all agents, seed COMPANY_MEMORY.md, and add weekly cron for institutional memory updates.

Purpose: Cross-agent memory search via QMD enables Directors to query shared knowledge (schemas, capabilities, company memory) without reading entire files. The COMPANY_MEMORY.md + weekly cron creates institutional memory that outlasts individual sessions. This is the knowledge infrastructure for The Organization.

Output: Updated bootstrap.sh with QMD collection setup, MCP server config, COMPANY_MEMORY.md template, and weekly cron.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/08-the-organization-director-workforce/08-RESEARCH.md
@.planning/phases/08-the-organization-director-workforce/08-01-SUMMARY.md
@ARCHITECTURE_PLAN.md
@scripts/bootstrap.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add QMD MCP server config and collection setup to bootstrap.sh</name>
  <files>scripts/bootstrap.sh</files>
  <action>
Add two new sections to bootstrap.sh:

**Section A: QMD MCP Server patch** — add BEFORE the `chmod 444` line, after the Director agent registration block. This adds QMD as a global MCP tool available to all agents.

```bash
# --- QMD MCP Server ---
# Add QMD as MCP server so all agents can use qmd_search, qmd_query tools
QMD_BIN="/data/.bun/bin/qmd"
if [ ! -x "$QMD_BIN" ]; then
  QMD_BIN="/data/.bun/install/global/bin/qmd"
fi
if [ -x "$QMD_BIN" ] || command -v qmd &>/dev/null; then
  HAS_QMD_MCP=$(jq -r '.mcp.servers.qmd // empty' "$CONFIG_FILE" 2>/dev/null)
  if [ -z "$HAS_QMD_MCP" ]; then
    QMD_PATH="$(command -v qmd 2>/dev/null || echo "$QMD_BIN")"
    jq --arg cmd "$QMD_PATH" '.mcp = (.mcp // {}) | .mcp.servers = (.mcp.servers // {}) | .mcp.servers.qmd = {"command": $cmd, "args": ["mcp"]}' \
      "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
    echo "[config] Added QMD as MCP server"
  fi
fi
```

**Section B: QMD Collection Setup** — add AFTER the `chmod 444` line and AFTER system services start (this is a non-config operation, runs independently). Place it after the BWS secrets section (around line 453) and before the NOVA memory section.

```bash
# --- QMD Multi-Collection Setup ---
QMD_BIN="/data/.bun/bin/qmd"
if [ ! -x "$QMD_BIN" ]; then
  QMD_BIN="/data/.bun/install/global/bin/qmd"
fi
QMD="$(command -v qmd 2>/dev/null || echo "$QMD_BIN")"
if [ -x "$QMD" ]; then
  # Company-wide memory (readable by all Directors)
  COMPANY_MEM="${WORKSPACE_DIR}/COMPANY_MEMORY.md"
  if [ -f "$COMPANY_MEM" ]; then
    "$QMD" collection add "$COMPANY_MEM" --name company 2>/dev/null || true
  fi

  # Supervisor schema registry (readable by all Directors)
  SUP_SCHEMAS="${WORKSPACE_DIR}/agents/automation-supervisor/memory/schemas"
  if [ -d "$SUP_SCHEMAS" ]; then
    "$QMD" collection add "$SUP_SCHEMAS" --name schemas 2>/dev/null || true
  fi

  # Main workspace memory
  if [ -d "${WORKSPACE_DIR}/memory" ]; then
    "$QMD" collection add "${WORKSPACE_DIR}/memory" --name main-workspace 2>/dev/null || true
  fi

  # Supervisor patterns (private to supervisor)
  SUP_PATTERNS="${WORKSPACE_DIR}/agents/automation-supervisor/memory/patterns"
  if [ -d "$SUP_PATTERNS" ]; then
    "$QMD" collection add "$SUP_PATTERNS" --name supervisor-patterns 2>/dev/null || true
  fi

  # Per-Director workspace memory collections
  for DIR_ID in budget-cfo business-researcher; do
    DIR_MEM="${WORKSPACE_DIR}/agents/${DIR_ID}/memory"
    if [ -d "$DIR_MEM" ]; then
      "$QMD" collection add "$DIR_MEM" --name "${DIR_ID}-workspace" 2>/dev/null || true
    fi
  done

  echo "[qmd] Collections configured"

  # Background index update (downloads 2GB models on first run — MUST NOT block gateway)
  nohup "$QMD" update --all-collections > /tmp/qmd-index.log 2>&1 &
  echo "[qmd] Background index update started (check /tmp/qmd-index.log)"
fi
```

IMPORTANT: The QMD collection setup runs AFTER chmod 444 because it does NOT modify openclaw.json. The MCP config patch runs BEFORE chmod 444.

IMPORTANT: QMD binary path is /data/.bun/bin/qmd (per user decision). Fall back to /data/.bun/install/global/bin/qmd.

IMPORTANT: `nohup ... &` for the index update — first run downloads ~2GB of GGUF models. On HDD server this takes 20-40 minutes. MUST NOT block gateway startup.
  </action>
  <verify>
Run `bash -n scripts/bootstrap.sh` to verify no syntax errors. Grep for QMD sections:
```
grep -c 'QMD' scripts/bootstrap.sh
```
Expected: 10+ matches.

Verify MCP patch is BEFORE chmod 444 and collection setup is AFTER:
```
grep -n 'QMD MCP Server\|chmod 444\|QMD Multi-Collection' scripts/bootstrap.sh
```
  </verify>
  <done>bootstrap.sh configures QMD as MCP server (before config lock) and sets up 6+ named collections (after config lock, in background).</done>
</task>

<task type="auto">
  <name>Task 2: Seed COMPANY_MEMORY.md and add weekly cron job</name>
  <files>scripts/bootstrap.sh</files>
  <action>
Add COMPANY_MEMORY.md seeding to the Director workspace seeding section (after the `seed_agent "main"` call, in the same area as Task 2 of 08-01). Then add a weekly cron for the main agent to update it.

**Section A: COMPANY_MEMORY.md seeding** — add after the Director workspace seeding block:

```bash
# --- COMPANY_MEMORY.md (Institutional Memory) ---
COMPANY_MEM="${WORKSPACE_DIR}/COMPANY_MEMORY.md"
if [ ! -f "$COMPANY_MEM" ]; then
  cat > "$COMPANY_MEM" <<'COMPANYEOF'
# COMPANY_MEMORY.md - The Organization

Institutional memory maintained by the Main Agent. Updated weekly.
All Directors can search this file via QMD `company` collection.

## Active Directors

| Director | Domain | Session Key | Status |
|----------|--------|-------------|--------|
| Automation Supervisor | Platform & Infrastructure | hook:automation-supervisor | Active |
| Budget CFO | Finance | hook:budget-cfo | Active |
| Business Researcher | Research & Comms | hook:business-researcher | Active |

## Organizational Decisions
(Updated weekly by Main Agent from Director memory files)

## Lessons Learned
(Distilled from Director operations — patterns, failures, and insights)

## Capability Registry Summary
(See Automation Supervisor memory/schemas/capabilities.md for full registry)
COMPANYEOF
  echo "[seed] Created COMPANY_MEMORY.md"
fi
```

**Section B: Weekly cron** — add a native OpenClaw cron job for weekly COMPANY_MEMORY.md updates. This uses the OpenClaw cron system (already enabled in config). Add a cron entry to the main agent's workspace:

Create file `cron/weekly-retrospective.md` in the main workspace if it does not exist:

```bash
# --- Weekly Retrospective Cron ---
CRON_DIR="${WORKSPACE_DIR}/cron"
mkdir -p "$CRON_DIR"
RETRO_CRON="${CRON_DIR}/weekly-retrospective.md"
if [ ! -f "$RETRO_CRON" ]; then
  cat > "$RETRO_CRON" <<'CRONEOF'
---
schedule: "0 9 * * 1"
name: weekly-retrospective
model: openrouter/anthropic/claude-haiku-4-5
sessionKey: cron:weekly-retrospective
---

Review all Director memory files and update COMPANY_MEMORY.md with distilled organizational learning.

Steps:
1. Read each Director's memory/patterns/ files
2. Identify significant patterns, decisions, and lessons from the past week
3. Update COMPANY_MEMORY.md sections: Organizational Decisions, Lessons Learned, Capability Registry Summary
4. Keep COMPANY_MEMORY.md under 500 lines (summarize, don't dump)
5. Note the date of this review at the top of each updated section
CRONEOF
  echo "[seed] Created weekly-retrospective cron job"
fi
```

NOTE: OpenClaw's native cron system reads markdown files from the workspace with YAML frontmatter containing `schedule` (cron syntax) and `name`. The `model` field allows using a cheaper model for routine tasks. The `sessionKey` field creates an isolated session for the cron run.

If OpenClaw's cron does not support reading from a `cron/` subdirectory, an alternative is to add the cron entry via the openclaw.json `cron.jobs` array. Research did not definitively confirm the file-based cron pattern, so check the actual cron behavior during execution. If file-based cron does not work, fall back to adding a `cron.jobs` entry in the jq patch block.
  </action>
  <verify>
Run `bash -n scripts/bootstrap.sh` — no syntax errors.
```
grep -c 'COMPANY_MEMORY\|weekly-retrospective' scripts/bootstrap.sh
```
Expected: 4+ matches.
  </verify>
  <done>COMPANY_MEMORY.md template exists in main workspace. Weekly cron job configured to update institutional memory every Monday at 9 AM. QMD company collection indexes COMPANY_MEMORY.md for cross-agent search.</done>
</task>

</tasks>

<verification>
1. `bash -n scripts/bootstrap.sh` — no syntax errors
2. QMD MCP server config is patched BEFORE chmod 444
3. QMD collection setup runs AFTER chmod 444 (non-config operation)
4. `nohup ... &` ensures QMD indexing does not block gateway
5. COMPANY_MEMORY.md seeded with Director roster and section stubs
6. Weekly cron job file created with schedule and instructions
</verification>

<success_criteria>
- QMD configured as global MCP server (all agents get qmd_search tool)
- 6+ QMD collections: company, schemas, main-workspace, supervisor-patterns, budget-cfo-workspace, business-researcher-workspace
- COMPANY_MEMORY.md template seeded in main workspace
- Weekly retrospective cron job configured
- QMD indexing runs in background without blocking gateway
- All changes idempotent and safe on redeploy
</success_criteria>

<output>
After completion, create `.planning/phases/08-the-organization-director-workforce/08-04-SUMMARY.md`
</output>
