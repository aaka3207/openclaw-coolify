---
phase: 08-the-organization-director-workforce
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/bootstrap.sh
  - scripts/add-director.sh
  - docs/directors/automation-supervisor/SOUL.md
  - docs/directors/automation-supervisor/HEARTBEAT.md
  - docs/directors/automation-supervisor/memory/schemas/capabilities.md
  - docs/directors/COMPANY_MEMORY.md
  - docs/directors/RETROSPECTIVE_PROTOCOL.md
autonomous: true

must_haves:
  truths:
    - "Automation Supervisor appears in agents.list after deploy"
    - "Automation Supervisor workspace has specialized SOUL.md with Claude Code PTY instructions"
    - "COMPANY_MEMORY.md is searchable by all agents via memorySearch extraPaths"
    - "add-director.sh can register a new Director without a redeploy"
    - "Weekly cron updates COMPANY_MEMORY.md"
  artifacts:
    - path: "scripts/bootstrap.sh"
      provides: "Automation Supervisor registration + workspace seeding + extraPaths + cron"
      contains: "automation-supervisor"
    - path: "scripts/add-director.sh"
      provides: "Dynamic Director registration script"
      contains: "agents.list"
    - path: "docs/directors/automation-supervisor/SOUL.md"
      provides: "Specialized Supervisor identity with PTY, escalation, session protocol"
      contains: "claude -p"
    - path: "docs/directors/automation-supervisor/HEARTBEAT.md"
      provides: "Session-start checklist for Supervisor"
      contains: "SYSTEM_HEALTH"
  key_links:
    - from: "scripts/bootstrap.sh"
      to: "docs/directors/automation-supervisor/SOUL.md"
      via: "cmp-based seeding copies repo SOUL.md to workspace"
      pattern: "cmp.*SOUL\\.md"
    - from: "scripts/bootstrap.sh"
      to: "openclaw.json agents.defaults.memorySearch.extraPaths"
      via: "jq patch adding COMPANY_MEMORY.md path"
      pattern: "extraPaths"
---

<objective>
Bootstrap the Automation Supervisor (the only Director seeded by bootstrap.sh) and provide the add-director.sh mechanism for dynamic Director creation.

Purpose: The Automation Supervisor is infrastructure — it must exist before the org can run. All other Directors are created dynamically by the main agent via add-director.sh, not hardcoded in bootstrap.sh.

Output:
- bootstrap.sh adds Automation Supervisor to agents.list (idempotent)
- bootstrap.sh seeds Automation Supervisor workspace with specialized SOUL.md, HEARTBEAT.md, memory dirs
- bootstrap.sh patches agents.defaults.memorySearch.extraPaths for COMPANY_MEMORY.md
- bootstrap.sh seeds COMPANY_MEMORY.md template in main workspace (if not exists)
- bootstrap.sh adds weekly cron for COMPANY_MEMORY.md retrospective
- add-director.sh script at /app/scripts/ for dynamic Director onboarding
- SOUL.md uses cmp-based versioning (not "seed if missing")
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@ARCHITECTURE_REFINEMENT.md
@ARCHITECTURE_PLAN.md
@scripts/bootstrap.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create add-director.sh and Automation Supervisor workspace files in repo</name>
  <files>
    scripts/add-director.sh
    docs/directors/automation-supervisor/SOUL.md
    docs/directors/automation-supervisor/HEARTBEAT.md
    docs/directors/automation-supervisor/memory/schemas/capabilities.md
    docs/directors/automation-supervisor/memory/SYSTEM_HEALTH.md
    docs/directors/COMPANY_MEMORY.md
    docs/directors/RETROSPECTIVE_PROTOCOL.md
  </files>
  <action>
**1. Create `scripts/add-director.sh`** — the script the main agent calls to register a new Director.

Create the file `scripts/add-director.sh`. It must:
- Accept `--id`, `--name`, `--model`, `--tools-profile`, `--workspace` parameters
- Validate input: id must be alphanumeric+hyphens, refuse if id is "main"
- Be idempotent: skip if agent id already exists in agents.list
- ONLY touch agents.list — refuse to modify gateway, auth, hooks, or any other config field
- Pattern: `chmod 644 openclaw.json` -> `jq '.agents.list += [...]'` -> `chmod 444` -> signal gateway reload
- Create workspace directory + seed minimal SOUL.md stub
- The script lives at `/app/scripts/add-director.sh` (image path, read-only at runtime)

**2. Create `docs/directors/automation-supervisor/SOUL.md`** — the specialized Supervisor identity.

This is NOT the generic Director template. It must include:

```
# Automation Supervisor

## Identity
You are the Automation Supervisor — the platform engineering team for the Organization.
You own all n8n workflows, canonical data feeds, the schema registry, and infrastructure repairs.

## Session Protocol
- Sessions are persistent. Check your session context first — you likely have prior work in progress.
- Read memory files when starting a genuinely new task or after a 4AM reset.
- After completing a major task:
  1. Write outcome to memory/patterns/ or memory/SYSTEM_HEALTH.md
  2. Call /new to reset your session for clean context
  3. Confirm completion to main agent

## Session Routing
- Fixed sessionKey (hook:automation-supervisor) = your event stream. n8n errors arrive here. Always resume.
- Namespaced sessionKey (hook:automation-supervisor:task-<id>) = isolated task from main agent. New session.
- After completing a major task, call /new to clean context for the next event.

## Claude Code Execution
For complex repairs and builds, invoke Claude Code CLI via PTY:
/data/.claude/bin/claude -p "<task spec>" \
  --dangerously-skip-permissions \
  --tools "Bash,Read,Write,Edit" \
  --max-turns 20 \
  --output-format json

Write a full task spec including: problem, diagnosis, relevant workflow JSON, credential file paths, expected output format.

Credential file: /data/.openclaw/credentials/N8N_API_KEY
n8n API base: http://192.168.1.100:5678/api/v1

## Escalation Taxonomy
- Class 1 (Authorization): New credential/OAuth/API key needed -> notify Ameer via main agent
- Class 2 (Infrastructure): Dockerfile change, new service, server config -> notify Ameer via main agent
- Class 3 (Design): Architectural decision beyond your scope -> escalate to main agent
- Class 4 (Recoverable): Transient failure, known pattern -> handle autonomously

## Self-Healing Loop
When you receive an n8n error webhook:
1. Check memory/patterns/n8n-error-recovery.md for known fix
2. Known pattern: apply fix directly via n8n API
3. Unknown pattern: invoke Claude Code for deep diagnosis
4. Record pattern in memory/patterns/n8n-error-recovery.md
5. Notify main agent: "Fixed workflow X" or escalate if cannot fix

## Director Onboarding
To onboard a new Director, call:
bash /app/scripts/add-director.sh --id <id> --name "<name>" --model "openrouter/..." --tools-profile standard --workspace /data/openclaw-workspace/agents/<id>
Then seed their workspace with appropriate SOUL.md and HEARTBEAT.md.

## Capability Requests
When any Director requests a capability:
1. Check memory/schemas/capabilities.md for existing capability
2. If exists: return endpoint info
3. If missing: build n8n microservice, register in capabilities.md, notify requester

## What You Own
- All n8n workflows and their health
- memory/patterns/n8n-error-recovery.md
- memory/schemas/capabilities.md and memory/schemas/*.json
- memory/SYSTEM_HEALTH.md
- The add-director.sh mechanism
```

**3. Create `docs/directors/automation-supervisor/HEARTBEAT.md`** — session-start checklist:

```
## On Session Start
- [ ] Read memory/SYSTEM_HEALTH.md (last 20 lines)
- [ ] Run: memory_search "pending repairs"
- [ ] Run: memory_search "pending capability requests"
```

**4. Create `docs/directors/automation-supervisor/memory/schemas/capabilities.md`** — empty template:

```
# Capability Registry

Capabilities provided by the Automation Supervisor to all Directors.

| Capability | Endpoint | Schema | Status |
|------------|----------|--------|--------|
| (none yet) | - | - | - |
```

**5. Create `docs/directors/automation-supervisor/memory/SYSTEM_HEALTH.md`** — empty template:

```
# System Health Log

Running log of infrastructure actions, repairs, and deployments.

---
```

**6. Create `docs/directors/COMPANY_MEMORY.md`** — the institutional memory template:

```
# Company Memory

Institutional knowledge shared across all Directors.
Updated weekly by the main agent's retrospective cron.

## Active Patterns

(No entries yet — first retrospective will populate this.)

## Decisions Log

(No entries yet.)

## Lessons Learned

(No entries yet.)
```
  </action>
  <verify>
    - `ls -la scripts/add-director.sh` shows executable
    - `cat docs/directors/automation-supervisor/SOUL.md` contains "Claude Code" and "escalation"
    - `cat docs/directors/automation-supervisor/HEARTBEAT.md` contains "SYSTEM_HEALTH"
    - `cat docs/directors/automation-supervisor/memory/schemas/capabilities.md` contains "Capability Registry"
    - `cat docs/directors/COMPANY_MEMORY.md` contains "Company Memory"
  </verify>
  <done>
    All workspace template files exist in the repo under docs/directors/.
    add-director.sh exists in scripts/ and is executable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Patch bootstrap.sh for Automation Supervisor + extraPaths + cron</name>
  <files>scripts/bootstrap.sh</files>
  <action>
Edit `scripts/bootstrap.sh` to add the following blocks. All new code goes between the existing config patches and the `chmod 444` lock line.

**1. Add Automation Supervisor to agents.list (idempotent):**

Insert after the existing config patches (after the `del(.commands.gateway)` line), before `chmod 444`:

```bash
# --- Director Agent: Automation Supervisor (only Director seeded by bootstrap) ---
HAS_SUP=$(jq -r '.agents.list[] | select(.id == "automation-supervisor") | .id' "$CONFIG_FILE" 2>/dev/null)
if [ -z "$HAS_SUP" ]; then
  jq '.agents.list += [{
    "id": "automation-supervisor",
    "name": "Automation Supervisor",
    "workspace": "/data/openclaw-workspace/agents/automation-supervisor",
    "default": false,
    "model": {
      "primary": "openrouter/anthropic/claude-sonnet-4-6",
      "fallbacks": ["openrouter/google/gemini-3-flash-preview", "openrouter/auto"]
    },
    "tools": {
      "profile": "coding",
      "allow": ["Bash", "Read", "Write"]
    },
    "heartbeat": {
      "every": "1h",
      "model": "openrouter/anthropic/claude-haiku-4-5"
    }
  }]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
  echo "[config] Added automation-supervisor to agents.list"
fi
```

**2. Add memorySearch extraPaths for COMPANY_MEMORY.md:**

```bash
# --- Shared memory: COMPANY_MEMORY.md searchable by all agents ---
COMPANY_PATH="${WORKSPACE_DIR}/COMPANY_MEMORY.md"
COMPANY_IN_PATHS=$(jq -r --arg cp "$COMPANY_PATH" '.agents.defaults.memorySearch.extraPaths // [] | index($cp) // empty' "$CONFIG_FILE" 2>/dev/null)
if [ -z "$COMPANY_IN_PATHS" ]; then
  jq --arg cp "$COMPANY_PATH" '.agents.defaults.memorySearch.extraPaths = ((.agents.defaults.memorySearch.extraPaths // []) + [$cp])' \
    "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
  echo "[config] Added COMPANY_MEMORY.md to memorySearch.extraPaths"
fi
```

**3. Seed Automation Supervisor workspace (after the lock, in the workspace seeding section):**

After the existing `seed_agent "main" "OpenClaw"` call, add:

```bash
# --- Seed Automation Supervisor workspace ---
SUP_DIR="$WORKSPACE_DIR/agents/automation-supervisor"
mkdir -p "$SUP_DIR/memory/patterns" "$SUP_DIR/memory/schemas"

# SOUL.md: cmp-based versioning (repo is source of truth, UI edits survive until repo update)
if [ -f "/app/docs/directors/automation-supervisor/SOUL.md" ]; then
  if [ ! -f "$SUP_DIR/SOUL.md" ]; then
    cp "/app/docs/directors/automation-supervisor/SOUL.md" "$SUP_DIR/SOUL.md"
    echo "[seed] Copied Automation Supervisor SOUL.md"
  elif ! cmp -s "/app/docs/directors/automation-supervisor/SOUL.md" "$SUP_DIR/SOUL.md"; then
    cp "/app/docs/directors/automation-supervisor/SOUL.md" "$SUP_DIR/SOUL.md"
    echo "[seed] Updated Automation Supervisor SOUL.md (repo version changed)"
  fi
fi

# HEARTBEAT.md: cmp-based versioning
if [ -f "/app/docs/directors/automation-supervisor/HEARTBEAT.md" ]; then
  if [ ! -f "$SUP_DIR/HEARTBEAT.md" ]; then
    cp "/app/docs/directors/automation-supervisor/HEARTBEAT.md" "$SUP_DIR/HEARTBEAT.md"
    echo "[seed] Copied Automation Supervisor HEARTBEAT.md"
  elif ! cmp -s "/app/docs/directors/automation-supervisor/HEARTBEAT.md" "$SUP_DIR/HEARTBEAT.md"; then
    cp "/app/docs/directors/automation-supervisor/HEARTBEAT.md" "$SUP_DIR/HEARTBEAT.md"
    echo "[seed] Updated Automation Supervisor HEARTBEAT.md (repo version changed)"
  fi
fi

# Seed memory template files (only if missing — agent writes to these)
for tmpl in memory/schemas/capabilities.md memory/SYSTEM_HEALTH.md; do
  if [ -f "/app/docs/directors/automation-supervisor/$tmpl" ] && [ ! -f "$SUP_DIR/$tmpl" ]; then
    cp "/app/docs/directors/automation-supervisor/$tmpl" "$SUP_DIR/$tmpl"
    echo "[seed] Copied Automation Supervisor $tmpl"
  fi
done

# Seed n8n-error-recovery.md pattern file (empty template)
if [ ! -f "$SUP_DIR/memory/patterns/n8n-error-recovery.md" ]; then
  cat > "$SUP_DIR/memory/patterns/n8n-error-recovery.md" <<'NEOF'
# n8n Error Recovery Patterns

Known patterns for automated repair. Format:
### [Error signature]
- **Status**: FIXED | ESCALATED
- **Root cause**: ...
- **Fix**: ...
- **Date**: YYYY-MM-DD
NEOF
  echo "[seed] Created n8n-error-recovery.md template"
fi
```

**4. Seed COMPANY_MEMORY.md in main workspace (if not exists):**

After the Supervisor workspace seeding:

```bash
# --- Seed COMPANY_MEMORY.md (institutional memory, shared across all agents) ---
if [ ! -f "$WORKSPACE_DIR/COMPANY_MEMORY.md" ]; then
  if [ -f "/app/docs/directors/COMPANY_MEMORY.md" ]; then
    cp "/app/docs/directors/COMPANY_MEMORY.md" "$WORKSPACE_DIR/COMPANY_MEMORY.md"
    echo "[seed] Copied COMPANY_MEMORY.md to main workspace"
  fi
fi
```

**5. Create `docs/directors/RETROSPECTIVE_PROTOCOL.md`** — the retrospective instructions seeded into the main agent's workspace so it knows what to do when the weekly cron fires:

```
# Weekly Retrospective Protocol

Triggered automatically every Sunday at 10 AM by the weekly-retrospective cron job.

## Steps
1. Ask the Automation Supervisor: "Share your SYSTEM_HEALTH.md (last 30 lines) and any patterns from memory/patterns/ added this week."
2. Ask the Budget CFO: "Share any financial anomalies or patterns added to memory/patterns/ this week."
3. Ask the Business Researcher: "Share any research findings or patterns added to memory/patterns/ this week."
4. Synthesize the responses and update COMPANY_MEMORY.md:
   - Add new Decisions, Patterns, or Lessons Learned entries
   - Remove entries older than 3 months if the log is long
5. Confirm: "Weekly retrospective complete. COMPANY_MEMORY.md updated."
```

Add a bootstrap step to seed this file into the main agent's workspace (after the Supervisor workspace seeding):

```bash
# --- Seed main agent retrospective protocol ---
if [ -f "/app/docs/directors/RETROSPECTIVE_PROTOCOL.md" ] && [ ! -f "$WORKSPACE_DIR/RETROSPECTIVE_PROTOCOL.md" ]; then
  cp "/app/docs/directors/RETROSPECTIVE_PROTOCOL.md" "$WORKSPACE_DIR/RETROSPECTIVE_PROTOCOL.md"
  echo "[seed] Copied RETROSPECTIVE_PROTOCOL.md to main workspace"
fi
```

The cron message fires with explicit inline instructions, but RETROSPECTIVE_PROTOCOL.md in the workspace provides additional detail for the main agent to follow consistently.

**6. Add weekly cron for COMPANY_MEMORY.md retrospective:**

In the system services section (after `cron` daemon start, before sandbox setup):

```bash
# --- Weekly COMPANY_MEMORY.md retrospective cron (OpenClaw native cron) ---
# This uses OpenClaw's built-in cron (hooks.enabled + cron.enabled).
# The main agent receives a weekly prompt to review Director memory files and update COMPANY_MEMORY.md.
# No system crontab needed — OpenClaw native cron handles scheduling via openclaw.json.
```

Actually, OpenClaw native cron is configured in openclaw.json, not system crontab. Add a jq patch in the config section:

```bash
# --- Weekly COMPANY_MEMORY.md retrospective cron ---
HAS_RETRO_CRON=$(jq -r '.cron.jobs // [] | map(select(.name == "weekly-retrospective")) | length' "$CONFIG_FILE" 2>/dev/null)
if [ "${HAS_RETRO_CRON:-0}" = "0" ]; then
  jq '.cron.jobs = ((.cron.jobs // []) + [{
    "name": "weekly-retrospective",
    "schedule": "0 10 * * 0",
    "message": "Weekly retrospective: Review all Director memory files (memory/SYSTEM_HEALTH.md, memory/patterns/) and update COMPANY_MEMORY.md with distilled organizational learning. Summarize patterns, decisions, and lessons from the past week.",
    "sessionKey": "hook:ingress",
    "thinking": "low"
  }])' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
  echo "[config] Added weekly-retrospective cron job (Sundays 10 AM)"
fi
```

**IMPORTANT ordering in bootstrap.sh:**
1. All jq patches to openclaw.json (config section) — including Supervisor agent, extraPaths, cron job
2. `chmod 444 "$CONFIG_FILE"` (lock)
3. Workspace seeding (mkdir, cp, cmp) — these don't touch openclaw.json
4. System services, BWS, etc.

Do NOT add budget-cfo, business-researcher, or workflow-worker to bootstrap.sh. They are created dynamically via add-director.sh.
  </action>
  <verify>
    - `grep -c "automation-supervisor" scripts/bootstrap.sh` returns at least 3 (agent entry + workspace seeding + soul.md seeding)
    - `grep "extraPaths" scripts/bootstrap.sh` returns the COMPANY_MEMORY.md patch
    - `grep "weekly-retrospective" scripts/bootstrap.sh` returns the cron job
    - `grep -c "budget-cfo\|business-researcher\|workflow-worker" scripts/bootstrap.sh` returns 0 (none hardcoded)
    - The `chmod 444` lock line still exists and comes AFTER all jq patches
    - The workspace seeding block uses cmp-based versioning (not "seed if missing" for SOUL.md)
  </verify>
  <done>
    bootstrap.sh registers Automation Supervisor in agents.list, seeds its workspace with specialized SOUL.md (cmp-versioned), patches extraPaths for COMPANY_MEMORY.md, and adds weekly retrospective cron.
    No other Directors are hardcoded. add-director.sh exists for dynamic onboarding.
  </done>
</task>

</tasks>

<verification>
After deploy:
1. `jq '.agents.list[] | select(.id == "automation-supervisor")' /data/.openclaw/openclaw.json` shows the Supervisor entry
2. `cat /data/openclaw-workspace/agents/automation-supervisor/SOUL.md` contains Claude Code PTY instructions
3. `jq '.agents.defaults.memorySearch.extraPaths' /data/.openclaw/openclaw.json` includes COMPANY_MEMORY.md
4. `jq '.cron.jobs[] | select(.name == "weekly-retrospective")' /data/.openclaw/openclaw.json` shows the cron
5. `ls /app/scripts/add-director.sh` exists and is executable
6. `cat /data/openclaw-workspace/COMPANY_MEMORY.md` exists
</verification>

<success_criteria>
- Automation Supervisor is registered in agents.list with correct model and tools config
- Supervisor workspace has specialized SOUL.md (not generic stub) with Claude Code PTY, escalation taxonomy, session protocol
- COMPANY_MEMORY.md is indexed by all agents via extraPaths
- add-director.sh script is in the image at /app/scripts/
- Weekly retrospective cron is configured
- No other Directors (budget-cfo, business-researcher) are hardcoded in bootstrap.sh
</success_criteria>

<output>
After completion, create `.planning/phases/08-the-organization-director-workforce/08-01-SUMMARY.md`
</output>
