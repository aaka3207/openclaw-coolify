---
phase: 08-the-organization-director-workforce
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/bootstrap.sh
  - scripts/add-director.sh
  - docs/reference/agents/automation-supervisor/SOUL.md
  - docs/reference/agents/automation-supervisor/HEARTBEAT.md
  - docs/reference/COMPANY_MEMORY.md
  - workspace/cron/weekly-retrospective.md
autonomous: true

must_haves:
  truths:
    - "automation-supervisor appears in agents.list with workspace, model (with fallbacks), and heartbeat"
    - "Automation Supervisor workspace is seeded with SOUL.md and HEARTBEAT.md via cmp-based update on every deploy"
    - "COMPANY_MEMORY.md is indexed by all agents via agents.defaults.memorySearch.extraPaths patch"
    - "add-director.sh exists at /app/scripts/add-director.sh and is idempotent (skips if agent already registered)"
    - "Weekly retrospective cron file exists in main agent workspace at cron/weekly-retrospective.md"
    - "ANTHROPIC_API_KEY is written to /data/.openclaw/credentials/ANTHROPIC_API_KEY by bootstrap.sh BWS loop"
    - "SOUL.md says check session context first — does NOT say wake fresh"
    - "SOUL.md uses memory_search, NOT QMD references"
  artifacts:
    - path: "scripts/bootstrap.sh"
      provides: "automation-supervisor jq patch, extraPaths patch, ANTHROPIC_API_KEY credential write, workspace seeding with cmp logic"
      contains: "automation-supervisor"
    - path: "scripts/add-director.sh"
      provides: "Director lifecycle primitive — validates input, idempotent, creates workspace, seeds SOUL/HEARTBEAT, patches config, sends SIGHUP"
    - path: "docs/reference/agents/automation-supervisor/SOUL.md"
      provides: "Automation Supervisor identity, Claude Code PTY usage, escalation taxonomy Classes 1-4, session protocol"
      min_lines: 60
    - path: "docs/reference/agents/automation-supervisor/HEARTBEAT.md"
      provides: "Session-start checklist with memory_search queries for pending repairs and capability requests"
    - path: "docs/reference/COMPANY_MEMORY.md"
      provides: "Org-wide institutional memory template with structured sections"
    - path: "workspace/cron/weekly-retrospective.md"
      provides: "Weekly cron spec for main agent retrospective distillation"
  key_links:
    - from: "scripts/bootstrap.sh"
      to: "agents.defaults.memorySearch.extraPaths"
      via: "jq idempotent membership check before appending"
      pattern: "extraPaths"
    - from: "scripts/bootstrap.sh"
      to: "/data/openclaw-workspace/agents/automation-supervisor/SOUL.md"
      via: "cmp -s check before cp"
      pattern: "cmp -s.*SOUL"
    - from: "scripts/add-director.sh"
      to: "/data/.openclaw/openclaw.json"
      via: "chmod 644 -> jq patch -> chmod 444 -> SIGHUP"
      pattern: "chmod 644"
---

<objective>
Bootstrap the Automation Supervisor as the first Director and establish the Director lifecycle infrastructure. This plan creates the foundation that all other Phase 8 plans depend on: automation-supervisor in agents.list, the add-director.sh script for future Directors, COMPANY_MEMORY.md cross-agent indexing, Automation Supervisor workspace files, and the weekly retrospective cron.

Purpose: No Director can be registered, no self-healing loop can be wired, and no end-to-end verification can run until these artifacts exist. This is Wave 1.
Output: Working automation-supervisor agent, add-director.sh lifecycle script, org-wide memory infrastructure, weekly cron.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@scripts/bootstrap.sh
@ARCHITECTURE_PLAN.md
@ARCHITECTURE_REFINEMENT.md
@.planning/phases/08-the-organization-director-workforce/08-CONTEXT.md
@.planning/phases/08-the-organization-director-workforce/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Patch bootstrap.sh — automation-supervisor agent, COMPANY_MEMORY extraPaths, workspace seeding, ANTHROPIC_API_KEY credential</name>
  <files>scripts/bootstrap.sh</files>
  <action>
Four additions to bootstrap.sh. Read the file first to confirm exact line numbers before editing.

**ADDITION A — Automation Supervisor workspace seeding (cmp-based)**

Insert after the `seed_agent "main" "OpenClaw"` call (around line 125). Add this block:

```bash
# Seed Automation Supervisor workspace (cmp-based: propagates repo updates on redeploy)
# Per ARCHITECTURE_REFINEMENT.md Section 9 and Section 10
SUPERVISOR_DIR="/data/openclaw-workspace/agents/automation-supervisor"
mkdir -p "$SUPERVISOR_DIR/memory/patterns" "$SUPERVISOR_DIR/memory/schemas"

for doc in SOUL.md HEARTBEAT.md; do
  REPO_DOC="/app/docs/reference/agents/automation-supervisor/$doc"
  DEST="$SUPERVISOR_DIR/$doc"
  if [ -f "$REPO_DOC" ]; then
    if [ ! -f "$DEST" ]; then
      cp "$REPO_DOC" "$DEST"
      echo "[seed] Copied automation-supervisor/$doc"
    elif ! cmp -s "$REPO_DOC" "$DEST"; then
      cp "$REPO_DOC" "$DEST"
      echo "[seed] Updated automation-supervisor/$doc (repo version changed)"
    fi
  fi
done

# AGENTS.md: seed if missing — agent's own version takes precedence once seeded
if [ -f "/app/AGENTS.md" ] && [ ! -f "$SUPERVISOR_DIR/AGENTS.md" ]; then
  cp "/app/AGENTS.md" "$SUPERVISOR_DIR/AGENTS.md"
  echo "[seed] Copied AGENTS.md to automation-supervisor workspace"
fi

# COMPANY_MEMORY.md: seed to main workspace if missing
COMPANY_MEM="${WORKSPACE_DIR}/COMPANY_MEMORY.md"
if [ ! -f "$COMPANY_MEM" ] && [ -f "/app/docs/reference/COMPANY_MEMORY.md" ]; then
  cp "/app/docs/reference/COMPANY_MEMORY.md" "$COMPANY_MEM"
  echo "[seed] Created COMPANY_MEMORY.md in main workspace"
fi

# Weekly retrospective cron file: seed to main workspace if missing
CRON_DIR="${WORKSPACE_DIR}/cron"
mkdir -p "$CRON_DIR"
RETRO_SRC="/app/workspace/cron/weekly-retrospective.md"
RETRO_DEST="$CRON_DIR/weekly-retrospective.md"
if [ -f "$RETRO_SRC" ] && [ ! -f "$RETRO_DEST" ]; then
  cp "$RETRO_SRC" "$RETRO_DEST"
  echo "[seed] Created weekly-retrospective.md cron file in main workspace"
fi
```

**ADDITION B — automation-supervisor agents.list patch**

Insert inside the `if command -v jq &>/dev/null && [ -f "$CONFIG_FILE" ]; then` block, BEFORE the `chmod 444 "$CONFIG_FILE"` line. Place after existing jq patches (after the `del(.commands.gateway)` patch, around line 364):

```bash
# Patch: add automation-supervisor Director to agents.list (idempotent)
# Per ARCHITECTURE_REFINEMENT.md Section 10 — only Supervisor is hardcoded in bootstrap.sh
HAS_SUPERVISOR=$(jq -r '.agents.list[] | select(.id == "automation-supervisor") | .id' "$CONFIG_FILE" 2>/dev/null)
if [ -z "$HAS_SUPERVISOR" ]; then
  jq --arg ws "/data/openclaw-workspace/agents/automation-supervisor" \
     '.agents.list += [{
       "id": "automation-supervisor",
       "name": "Automation Supervisor",
       "workspace": $ws,
       "default": false,
       "model": {
         "primary": "openrouter/anthropic/claude-sonnet-4-6",
         "fallbacks": ["openrouter/google/gemini-3-flash-preview", "openrouter/auto"]
       },
       "heartbeat": {
         "every": "1h",
         "model": "openrouter/anthropic/claude-haiku-4-5"
       }
     }]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
  echo "[config] Added automation-supervisor Director to agents.list"
fi
```

**ADDITION C — COMPANY_MEMORY.md extraPaths patch**

Insert in the same jq patch block, after the automation-supervisor patch:

```bash
# Patch: add COMPANY_MEMORY.md to agents.defaults.memorySearch.extraPaths
# Per ARCHITECTURE_REFINEMENT.md Section 4 — one patch makes it searchable by ALL agents
COMPANY_MEM_PATH="${WORKSPACE_DIR}/COMPANY_MEMORY.md"
HAS_COMPANY_PATH=$(jq -r --arg p "$COMPANY_MEM_PATH" \
  '.agents.defaults.memorySearch.extraPaths // [] | index($p) // empty' \
  "$CONFIG_FILE" 2>/dev/null)
if [ -z "$HAS_COMPANY_PATH" ]; then
  jq --arg p "$COMPANY_MEM_PATH" \
     '.agents.defaults.memorySearch.extraPaths = ((.agents.defaults.memorySearch.extraPaths // []) + [$p] | unique)' \
     "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
  echo "[config] Added COMPANY_MEMORY.md to agents.defaults.memorySearch.extraPaths"
fi
```

**ADDITION D — ANTHROPIC_API_KEY in BWS credential write loop**

Find the existing BWS credential write loop (around line 446):
```bash
for var in N8N_API_KEY; do
```

Change it to:
```bash
for var in N8N_API_KEY ANTHROPIC_API_KEY; do
```

This writes ANTHROPIC_API_KEY from BWS secrets.env to `/data/.openclaw/credentials/ANTHROPIC_API_KEY` and unsets it from environment. The Automation Supervisor reads it when invoking Claude Code CLI.

**ORDERING CONSTRAINT**: All jq patches (B and C) MUST be inside the `if command -v jq` block and BEFORE the `chmod 444 "$CONFIG_FILE"` line. Workspace seeding (A) goes after `seed_agent "main"`. BWS loop change (D) is in the existing BWS write loop at the bottom.
  </action>
  <verify>
```bash
# Syntax check
bash -n scripts/bootstrap.sh && echo "syntax OK"
# Check all four additions exist
grep -c "automation-supervisor" scripts/bootstrap.sh
grep "COMPANY_MEM_PATH" scripts/bootstrap.sh
grep "ANTHROPIC_API_KEY" scripts/bootstrap.sh
grep "weekly-retrospective" scripts/bootstrap.sh
```
  </verify>
  <done>
- bash -n passes
- bootstrap.sh contains automation-supervisor jq patch (idempotent HAS_SUPERVISOR check)
- bootstrap.sh contains COMPANY_MEM_PATH extraPaths patch
- bootstrap.sh contains ANTHROPIC_API_KEY in the BWS credential loop
- bootstrap.sh seeds automation-supervisor SOUL.md and HEARTBEAT.md via cmp-based logic
- bootstrap.sh seeds COMPANY_MEMORY.md and cron/weekly-retrospective.md to main workspace
  </done>
</task>

<task type="auto">
  <name>Task 2: Create scripts/add-director.sh — idempotent Director registration script</name>
  <files>scripts/add-director.sh</files>
  <action>
Create `scripts/add-director.sh`. This is the Director lifecycle primitive. Per ARCHITECTURE_REFINEMENT.md Section 2: lives at `/app/scripts/` (image path, immutable to agents), validates input, idempotent, creates workspace, seeds SOUL.md and HEARTBEAT.md, patches config with lock/unlock cycle, sends SIGHUP.

```bash
#!/usr/bin/env bash
# add-director.sh — Register a new Director agent in openclaw.json
# Usage: add-director.sh <id> <name> [model]
# Example: add-director.sh budget-cfo "Budget CFO" "openrouter/anthropic/claude-sonnet-4-6"
# Lives at /app/scripts/ (image path, not agent-writable per ARCHITECTURE_REFINEMENT.md Section 2)
set -e

AGENT_ID="${1:-}"
AGENT_NAME="${2:-}"
AGENT_MODEL="${3:-openrouter/anthropic/claude-sonnet-4-6}"

CONFIG_FILE="${OPENCLAW_STATE_DIR:-/data/.openclaw}/openclaw.json"
WORKSPACE_BASE="/data/openclaw-workspace/agents"
HOOKS_TOKEN_FILE="/data/.openclaw/credentials/HOOKS_TOKEN"
GATEWAY_PORT="${OPENCLAW_GATEWAY_PORT:-18789}"

# --- Validate input ---
if [ -z "$AGENT_ID" ] || [ -z "$AGENT_NAME" ]; then
  echo "Usage: $0 <id> <name> [model]" >&2
  echo "Example: $0 budget-cfo \"Budget CFO\" \"openrouter/anthropic/claude-sonnet-4-6\"" >&2
  exit 1
fi

# Reject reserved ids — these are managed by bootstrap.sh
for reserved in main automation-supervisor; do
  if [ "$AGENT_ID" = "$reserved" ]; then
    echo "ERROR: '$AGENT_ID' is a reserved agent id. Use bootstrap.sh to manage this agent." >&2
    exit 1
  fi
done

# Validate id format: lowercase alphanumeric with hyphens, must start and end with alphanumeric
if ! echo "$AGENT_ID" | grep -qE '^[a-z0-9][a-z0-9-]*[a-z0-9]$'; then
  echo "ERROR: Agent id '$AGENT_ID' is invalid. Use lowercase alphanumeric with hyphens (e.g. budget-cfo)" >&2
  exit 1
fi

WORKSPACE_DIR="$WORKSPACE_BASE/$AGENT_ID"

# --- Idempotency check ---
EXISTING=$(jq -r --arg id "$AGENT_ID" '.agents.list[] | select(.id == $id) | .id' "$CONFIG_FILE" 2>/dev/null || true)
if [ -n "$EXISTING" ]; then
  echo "[add-director] Agent '$AGENT_ID' already registered in agents.list — skipping config patch"
  # Still ensure workspace and files exist (idempotent)
  mkdir -p "$WORKSPACE_DIR/memory/patterns"
  echo "[add-director] Workspace verified: $WORKSPACE_DIR"
  exit 0
fi

# --- Create workspace ---
mkdir -p "$WORKSPACE_DIR/memory/patterns"
echo "[add-director] Created workspace: $WORKSPACE_DIR"

# --- Seed SOUL.md ---
cat > "$WORKSPACE_DIR/SOUL.md" <<SOULEOF
# SOUL.md — ${AGENT_NAME}

You are **${AGENT_NAME}**, a Director in Ameer's autonomous AI workforce.

## Identity

You operate within the OpenClaw multi-agent system. Your sessions are persistent — hook POSTs to \`hook:${AGENT_ID}\` resume your current session. Check your session context first — you may already have prior context from earlier work in this session.

## Session Model

- **Persistent session** (\`hook:${AGENT_ID}\`): Resumes your current session. You accumulate context throughout the day.
- **Isolated task session** (\`hook:${AGENT_ID}:task-<id>\`): Fresh context for isolated work, no bleed from your event stream.
- **Daily reset**: Sessions reset at 4AM. Write all important state to \`memory/\` files BEFORE session ends.
- **After completing a major task**: Write outcome to \`memory/patterns/\`, then call \`/new\` to reset your session for the next incoming event.

## Memory Protocol

Use \`memory_search\` for all memory queries (built-in, no external tools needed):
- Query before reading files: \`memory_search "relevant topic"\`
- Your private memory is in your workspace \`memory/\` directory — auto-indexed by memorySearch
- Org-wide context is in COMPANY_MEMORY.md — also indexed and searchable

## Director Communication

To reach another Director or the main agent via the hooks endpoint:
\`\`\`bash
curl -X POST http://127.0.0.1:18789/hooks/agent \\
  -H "Authorization: Bearer \$(cat /data/.openclaw/credentials/HOOKS_TOKEN)" \\
  -H "Content-Type: application/json" \\
  -d '{"agentId": "target-id", "sessionKey": "hook:target-id", "message": "..."}'
\`\`\`

## Escalation Protocol

| Class | When | Action |
|-------|------|--------|
| Class 1: Authorization | New credential or OAuth consent needed | Escalate to main — notify Ameer |
| Class 2: Infrastructure | Dockerfile/server-level change needed | Escalate to main — notify Ameer |
| Class 3: Design | Architectural decision beyond your scope | Escalate to main — main decides |
| Class 4: Recoverable | Transient failure, known pattern | Handle autonomously |

## Your Domain

[Updated by main agent during Director onboarding — describes your specific domain, data sources, and responsibilities.]
SOULEOF
echo "[add-director] Seeded SOUL.md"

# --- Seed HEARTBEAT.md ---
cat > "$WORKSPACE_DIR/HEARTBEAT.md" <<HBEOF
# HEARTBEAT.md — ${AGENT_NAME}

## On Session Start

- Check session context — you may have prior work in progress from today
- Run: \`memory_search "pending tasks"\` — check for outstanding work
- Run: \`memory_search "recent updates"\` — what has changed?

## Periodic Checklist (1h heartbeat)

- [ ] Any unresolved items from your domain?
- [ ] Anything worth persisting to memory/patterns/?
- [ ] Session context stale or cluttered? Call \`/new\` before processing new work.

## Session End Protocol

- Write important outcomes to \`memory/patterns/\`
- Call \`/new\` to reset session for the next incoming event
HBEOF
echo "[add-director] Seeded HEARTBEAT.md"

# --- Seed AGENTS.md if available ---
if [ -f "/app/AGENTS.md" ]; then
  cp "/app/AGENTS.md" "$WORKSPACE_DIR/AGENTS.md"
  echo "[add-director] Copied AGENTS.md"
fi

# --- Patch openclaw.json (lock/unlock cycle per ARCHITECTURE_REFINEMENT.md Section 2) ---
chmod 644 "$CONFIG_FILE"

jq --arg id "$AGENT_ID" \
   --arg name "$AGENT_NAME" \
   --arg workspace "$WORKSPACE_DIR" \
   --arg model "$AGENT_MODEL" \
   '.agents.list += [{
     "id": $id,
     "name": $name,
     "workspace": $workspace,
     "default": false,
     "model": {
       "primary": $model,
       "fallbacks": ["openrouter/google/gemini-3-flash-preview", "openrouter/auto"]
     },
     "heartbeat": {
       "every": "1h",
       "model": "openrouter/anthropic/claude-haiku-4-5"
     }
   }]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"

chmod 444 "$CONFIG_FILE"
echo "[add-director] Registered $AGENT_ID in agents.list, config relocked"

# --- Gateway reload ---
# OPEN QUESTION (ARCHITECTURE_REFINEMENT.md Section 12.2): Does SIGHUP reload config?
# Try SIGHUP first. If gateway does not recognize new agent, container restart is required.
GATEWAY_PID=$(pgrep -f "openclaw gateway" 2>/dev/null || true)
if [ -n "$GATEWAY_PID" ]; then
  kill -HUP "$GATEWAY_PID" 2>/dev/null && echo "[add-director] Sent SIGHUP to gateway pid $GATEWAY_PID" || true
  sleep 3
else
  echo "[add-director] WARNING: Cannot find gateway pid. Config patched but gateway not reloaded."
  echo "[add-director] ACTION REQUIRED: Run 'docker restart <container>' to reload config for $AGENT_ID"
fi

# --- Verify gateway responds to new Director's hook endpoint ---
HOOKS_TOKEN=""
if [ -f "$HOOKS_TOKEN_FILE" ]; then
  HOOKS_TOKEN=$(cat "$HOOKS_TOKEN_FILE")
fi
if [ -n "$HOOKS_TOKEN" ]; then
  sleep 2
  HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
    -X POST "http://127.0.0.1:${GATEWAY_PORT}/hooks/agent" \
    -H "Authorization: Bearer $HOOKS_TOKEN" \
    -H "Content-Type: application/json" \
    -d "{\"agentId\": \"${AGENT_ID}\", \"sessionKey\": \"hook:${AGENT_ID}\", \"message\": \"Director registration confirmed. Please introduce yourself briefly.\"}" \
    --max-time 10 2>/dev/null || echo "000")
  if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "202" ]; then
    echo "[add-director] SUCCESS: $AGENT_ID is live (HTTP $HTTP_STATUS)"
  else
    echo "[add-director] WARNING: Gateway returned HTTP $HTTP_STATUS for hook:${AGENT_ID}"
    echo "[add-director] If SIGHUP did not reload config, restart the container to activate $AGENT_ID"
  fi
fi

echo "[add-director] Done: $AGENT_ID ($AGENT_NAME) registered"
```

After writing the file: `chmod +x scripts/add-director.sh`
  </action>
  <verify>
```bash
bash -n scripts/add-director.sh && echo "syntax OK"
ls -la scripts/add-director.sh | grep "x"
# Test validation
bash scripts/add-director.sh 2>&1 | grep -i "usage"
bash scripts/add-director.sh main "Main" 2>&1 | grep -i "reserved"
bash scripts/add-director.sh "Bad ID" "Bad" 2>&1 | grep -i "error"
grep "idempotency\|already registered" scripts/add-director.sh
grep "chmod 644" scripts/add-director.sh
grep "chmod 444" scripts/add-director.sh
grep "SIGHUP\|kill -HUP" scripts/add-director.sh
```
  </verify>
  <done>
- bash -n passes (valid syntax)
- File is executable
- Missing args prints usage
- Reserved id (main, automation-supervisor) prints error and exits 1
- Malformed id prints error and exits 1
- Script contains idempotency check (skips config patch if agent already exists)
- Script contains chmod 644 -> jq -> chmod 444 cycle
- Script contains SIGHUP attempt and HTTP verification
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Automation Supervisor SOUL.md, HEARTBEAT.md, COMPANY_MEMORY.md template, and weekly retrospective cron file</name>
  <files>
    docs/reference/agents/automation-supervisor/SOUL.md
    docs/reference/agents/automation-supervisor/HEARTBEAT.md
    docs/reference/COMPANY_MEMORY.md
    workspace/cron/weekly-retrospective.md
  </files>
  <action>
Create four repo-side template files that bootstrap.sh seeds into the container. Create directories first.

**File 1: `docs/reference/agents/automation-supervisor/SOUL.md`**

This is the most detailed Director SOUL.md. Must include: session model (check context first), Claude Code PTY, escalation taxonomy, self-healing protocol, add-director.sh usage. Must NOT say "wake fresh". Must NOT reference QMD.

```markdown
# SOUL.md — Automation Supervisor

You are the **Automation Supervisor**, the platform engineering Director in Ameer's autonomous AI workforce. You own all n8n workflows, the canonical data infrastructure, and the schema registry. You build and repair the infrastructure all other Directors depend on.

## Identity

You are persistent. Check your session context first — you likely have prior work in progress from today's session (errors seen, patterns recognized, repairs in flight). Your session key `hook:automation-supervisor` resumes your running context throughout the day.

## Session Model

- **Event stream** (`hook:automation-supervisor`): All n8n error webhooks arrive here. You accumulate context on failures throughout the day — you can see that "this is the 3rd Krisp timeout today."
- **Isolated tasks** (`hook:automation-supervisor:task-<id>`): When main agent delegates a specific build task, use this namespaced key to avoid contaminating your error stream context.
- **Daily reset**: Sessions reset at 4AM. Write all important state to `memory/` files BEFORE session ends.
- **After completing a major task**: Write outcome to `memory/patterns/` or `memory/SYSTEM_HEALTH.md`, then call `/new` to reset session for the next incoming event.

## Memory Protocol

Use `memory_search` (built-in tool) for all memory queries — do NOT use QMD:
- Before diagnosing an n8n error: `memory_search "known fix for [error type]"`
- Before building a new capability: `memory_search "existing capabilities"`
- Before cross-agent queries: `memory_search "company [topic]"` (COMPANY_MEMORY.md is indexed)
- Rule: query first, read full files only if the query returns nothing useful

## Claude Code Execution Layer

When diagnosing complex failures or building new workflows that require code analysis or multi-step changes, invoke Claude Code via PTY:

```bash
ANTHROPIC_API_KEY="$(cat /data/.openclaw/credentials/ANTHROPIC_API_KEY)" \
  /data/.local/bin/claude -p "task description here" \
  --dangerously-skip-permissions \
  --tools "Bash,Read,Write" \
  --max-turns 20 \
  --output-format json \
  --no-session-persistence
```

**Use `claude -p` for:**
- Deep n8n workflow diagnosis requiring code analysis
- Building new microservices (write + test + deploy cycle)
- Infrastructure changes involving multiple files or complex logic

**Use direct tool calls for:**
- Simple n8n API calls (GET workflow, PATCH node, activate/deactivate)
- Reading credential files
- Writing to your memory files

**Credential locations:**
- n8n API key: `cat /data/.openclaw/credentials/N8N_API_KEY`
- n8n API base URL: `http://192.168.1.100:5678/api/v1`
- HOOKS_TOKEN for Director communication: `cat /data/.openclaw/credentials/HOOKS_TOKEN`

## Self-Healing Loop Protocol

When an n8n error arrives via hook:
1. Check session context — have you seen this workflow or error pattern today?
2. `memory_search "n8n error [workflow name] [error type]"` — find known fixes
3. **Known pattern**: apply fix directly via n8n API, activate workflow, write updated pattern to `memory/patterns/n8n-error-recovery.md`
4. **Unknown pattern**: write task spec to `/tmp/supervisor-task-$(date +%s).json`, invoke Claude Code via PTY for diagnosis and fix
5. Record outcome in `memory/patterns/n8n-error-recovery.md`
6. Notify main agent: POST to `hook:main` with repair summary

Infinite loop protection: n8n does not trigger the error workflow for the error workflow itself. This is built-in.

## Director Communication

To reach another Director or the main agent:
```bash
curl -X POST http://127.0.0.1:18789/hooks/agent \
  -H "Authorization: Bearer $(cat /data/.openclaw/credentials/HOOKS_TOKEN)" \
  -H "Content-Type: application/json" \
  -d '{"agentId": "budget-cfo", "sessionKey": "hook:budget-cfo", "message": "..."}'
```

Always include both `agentId` AND `sessionKey` — without `agentId`, the message routes to the default agent (main), not the intended Director.

## Director Lifecycle (add-director.sh)

To register a new Director when instructed by main agent:
```bash
bash /app/scripts/add-director.sh <agent-id> "<Agent Name>" "<model>"
# Example:
bash /app/scripts/add-director.sh budget-cfo "Budget CFO" "openrouter/anthropic/claude-sonnet-4-6"
```

The script is idempotent (safe to call multiple times). After registration:
1. Verify the Director's hook endpoint responds (the script does this automatically)
2. If SIGHUP did not reload config, a container restart is required
3. POST the Director intake brief to their session to complete onboarding

## Escalation Taxonomy

| Class | Definition | Examples | Action |
|-------|-----------|---------|--------|
| Class 1: Authorization | New credential, OAuth consent, or API key needed | New Gmail OAuth scope, Monarch API key rotation | Escalate to main — notify Ameer |
| Class 2: Infrastructure | Dockerfile change, new Docker service, server-level config | New dependency, port change | Escalate to main — notify Ameer |
| Class 3: Design | Architectural decision beyond your scope | Fundamental workflow redesign, new Director needed | Escalate to main — main decides, may involve Ameer |
| Class 4: Recoverable | Transient failure, known pattern, self-healing applicable | API timeout, rate limit, malformed payload | Handle autonomously |

## Your Domain

- **Owns**: all n8n workflows, canonical data feeds, schema registry (`memory/schemas/`)
- **Builds**: new microservices, capability layer, reusable sub-workflows requested by other Directors
- **Repairs**: failed workflows, broken nodes, capability gaps via the self-healing loop
- **Executes**: complex infrastructure tasks via Claude Code PTY
- **Registers**: new Directors via `add-director.sh` when instructed by main agent
```

**File 2: `docs/reference/agents/automation-supervisor/HEARTBEAT.md`**

```markdown
# HEARTBEAT.md — Automation Supervisor

## On Session Start

- Check session context first — you likely have prior repairs or capability requests in progress from today
- Run: `memory_search "pending repairs"` — check for unresolved workflow failures
- Run: `memory_search "pending capability requests"` — check for Director requests awaiting action
- Read last 20 lines of `memory/SYSTEM_HEALTH.md` for current infrastructure state

## Periodic Checklist (1h heartbeat)

- [ ] Any new n8n errors since last check? (check session context and error stream)
- [ ] Any capability requests from Directors? (`memory_search "capability request"`)
- [ ] Any workflows currently in error state?
  ```bash
  curl -s "http://192.168.1.100:5678/api/v1/executions?status=error&limit=5" \
    -H "X-N8N-API-KEY: $(cat /data/.openclaw/credentials/N8N_API_KEY)"
  ```
- [ ] Anything important to write to `memory/SYSTEM_HEALTH.md`?

## Session End Protocol

- Write important outcomes to `memory/patterns/n8n-error-recovery.md` or `memory/SYSTEM_HEALTH.md`
- If you completed a major task: call `/new` to reset session before the next incoming event arrives
```

**File 3: `docs/reference/COMPANY_MEMORY.md`**

```markdown
# COMPANY_MEMORY.md — Organizational Memory

This file is the institutional memory of Ameer's AI workforce. It is indexed by all agents via `memory_search`. The main agent distills organizational learnings here weekly.

**Updated by**: Main agent (weekly retrospective cron, Sunday 6 AM)
**Searchable by**: All agents (indexed via agents.defaults.memorySearch.extraPaths)
**Indexed automatically**: No manual re-index required (watch mode enabled)

---

## Infrastructure

<!-- Automation Supervisor documents key infrastructure decisions and patterns here -->
<!-- Example: "n8n API rate limit: 100 req/min. Monarch transactions batch at 2 AM." -->

## Director Patterns

<!-- Recurring patterns observed across Directors -->
<!-- Example: "CFO escalates Monarch API issues on Fridays — Chase batch window" -->

## Capability Registry

<!-- What capabilities have been built and are available — updated by Automation Supervisor -->
<!-- Example: "email.received feed: POST to /hooks with sessionKey hook:budget-cfo for financial emails" -->

## Organizational Decisions

<!-- Architectural and strategic decisions Directors should be aware of -->
<!-- Example: "Directors communicate via HTTP POST curl, not tools.agentToAgent" -->

---

*Last updated: [date]*
*Updated by: [agent]*
```

**File 4: `workspace/cron/weekly-retrospective.md`**

Note from ARCHITECTURE_REFINEMENT.md Section 11 and CONTEXT.md: file-based cron format is unverified. Include YAML frontmatter AND a note for the executor to verify at runtime.

```markdown
---
# OPEN QUESTION (verify at execution time — ARCHITECTURE_REFINEMENT.md Section 11):
# Does OpenClaw read cron specs from workspace cron/ subdirectory files?
# If YES: this file triggers automatically.
# If NO (only cron.jobs in openclaw.json works): add jq patch to bootstrap.sh as fallback.
# Document finding in 08-01-SUMMARY.md.
schedule: "0 6 * * 0"
agent: main
description: "Weekly organizational retrospective — distill Director memory into COMPANY_MEMORY.md"
---

# Weekly Retrospective

You are performing the weekly organizational retrospective. Distill this week's learnings into `COMPANY_MEMORY.md`.

## Steps

1. `memory_search "this week"` — what patterns and outcomes emerged?
2. `memory_search "decisions"` — what was decided this week?
3. `memory_search "capability"` — what new capabilities were built?
4. Read last 30 lines of `/data/openclaw-workspace/agents/automation-supervisor/memory/SYSTEM_HEALTH.md` if it exists
5. Write 3-5 concise distilled learnings to the relevant section of `COMPANY_MEMORY.md`
6. Update the "Last updated" line in COMPANY_MEMORY.md

Keep entries brief — this file grows over time. Add only what future Directors would genuinely benefit from knowing.
```

Create directories before writing files:
```bash
mkdir -p docs/reference/agents/automation-supervisor
mkdir -p docs/reference
mkdir -p workspace/cron
```
  </action>
  <verify>
```bash
ls docs/reference/agents/automation-supervisor/SOUL.md
ls docs/reference/agents/automation-supervisor/HEARTBEAT.md
ls docs/reference/COMPANY_MEMORY.md
ls workspace/cron/weekly-retrospective.md
# Quality checks on SOUL.md
grep -c "memory_search" docs/reference/agents/automation-supervisor/SOUL.md
grep "check your session context\|Check your session context" docs/reference/agents/automation-supervisor/SOUL.md
grep "Class 4" docs/reference/agents/automation-supervisor/SOUL.md
grep "claude -p" docs/reference/agents/automation-supervisor/SOUL.md
# Ensure no QMD or wake fresh
grep -i "qmd" docs/reference/agents/automation-supervisor/SOUL.md && echo "FAIL: QMD found" || echo "PASS: QMD-free"
grep -i "wake fresh" docs/reference/agents/automation-supervisor/SOUL.md && echo "FAIL: wake fresh found" || echo "PASS: session model OK"
```
  </verify>
  <done>
- All 4 files created in correct paths
- SOUL.md contains: memory_search (not QMD), claude -p invocation, "Check your session context first", escalation Classes 1-4, add-director.sh usage, n8n credential paths
- SOUL.md does NOT contain: "QMD", "wake fresh", "wake up fresh", "start fresh"
- HEARTBEAT.md contains: session-start checklist with memory_search queries, n8n error state check, session end protocol
- COMPANY_MEMORY.md is a structured template with 4 sections
- weekly-retrospective.md contains cron YAML frontmatter, OPEN QUESTION note, and 5-step retrospective instructions
  </done>
</task>

</tasks>

<verification>
After deploying (git push to trigger webhook redeploy):

```bash
CONTAINER=$(sudo docker ps --format '{{.Names}}' | grep openclaw | grep -v proxy | grep -v searxng | head -1)

# 1. Gateway healthy
sudo docker logs $CONTAINER --tail 20 | grep -i error || echo "No errors"

# 2. automation-supervisor in agents.list
sudo docker exec $CONTAINER jq '[.agents.list[] | .id]' /data/.openclaw/openclaw.json

# 3. extraPaths includes COMPANY_MEMORY.md
sudo docker exec $CONTAINER jq '.agents.defaults.memorySearch.extraPaths' /data/.openclaw/openclaw.json

# 4. Supervisor workspace seeded
sudo docker exec $CONTAINER ls /data/openclaw-workspace/agents/automation-supervisor/

# 5. COMPANY_MEMORY.md in main workspace
sudo docker exec $CONTAINER ls /data/openclaw-workspace/COMPANY_MEMORY.md

# 6. add-director.sh exists and is executable
sudo docker exec $CONTAINER ls -la /app/scripts/add-director.sh

# 7. No QMD in SOUL.md
sudo docker exec $CONTAINER grep -i qmd /data/openclaw-workspace/agents/automation-supervisor/SOUL.md && echo "FAIL" || echo "PASS"

# 8. Test hook to automation-supervisor
HOOKS_TOKEN=$(sudo docker exec $CONTAINER cat /data/.openclaw/credentials/HOOKS_TOKEN)
curl -X POST http://192.168.1.100:18789/hooks/agent \
  -H "Authorization: Bearer $HOOKS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"agentId": "automation-supervisor", "sessionKey": "hook:automation-supervisor", "message": "System check: introduce yourself and confirm your session model."}'
```
</verification>

<success_criteria>
- Gateway starts after deploy, no startup errors in logs
- agents.list contains exactly 2 entries: main and automation-supervisor
- extraPaths array contains COMPANY_MEMORY.md path
- /data/openclaw-workspace/agents/automation-supervisor/ contains: SOUL.md, HEARTBEAT.md, AGENTS.md, memory/patterns/, memory/schemas/
- SOUL.md says "Check your session context first" and does NOT mention QMD or "wake fresh"
- add-director.sh is executable, valid bash, rejects reserved ids, contains chmod 644/444 cycle
- Hook POST to automation-supervisor returns HTTP 200 or 202
</success_criteria>

<output>
After completion, create `.planning/phases/08-the-organization-director-workforce/08-01-SUMMARY.md`

Include:
- Files created/modified with brief description
- bootstrap.sh patch locations (line numbers after edit)
- Whether file-based cron (cron/ subdirectory) was verified — document the finding
- Whether ANTHROPIC_API_KEY was in BWS at deploy time — if not, note what's needed
- SIGHUP vs restart finding (if tested live)
- Any deviations from this plan
</output>
