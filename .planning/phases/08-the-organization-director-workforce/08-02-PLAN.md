---
phase: 08-the-organization-director-workforce
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Claude Code CLI is executable from within the OpenClaw container"
    - "Claude Code can authenticate (API key or OAuth) for headless invocations"
    - "Automation Supervisor SOUL.md references the correct Claude Code binary path"
  artifacts:
    - path: "/data/.claude/bin/claude"
      provides: "Claude Code CLI binary"
    - path: "/data/.openclaw/credentials/ANTHROPIC_API_KEY"
      provides: "API key for Claude Code headless invocation"
  key_links:
    - from: "docs/directors/automation-supervisor/SOUL.md"
      to: "/data/.claude/bin/claude"
      via: "PTY invocation path in SOUL.md"
      pattern: "/data/.claude/bin/claude"
---

<objective>
Install Claude Code CLI on the server and authenticate it for headless use by the Automation Supervisor.

Purpose: The Supervisor needs Claude Code as its execution layer for complex repairs and builds. Claude Code uses Ameer's Claude Max plan (no API token cost) or an ANTHROPIC_API_KEY.

Output:
- Claude Code binary installed at `/data/.claude/bin/claude` (persistent volume)
- Authentication configured (API key in credential file or OAuth tokens)
- Verified: `claude --version` works from container
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-the-organization-director-workforce/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Claude Code CLI on the server</name>
  <files>/data/.claude/bin/claude</files>
  <action>
SSH into the server and install Claude Code inside the running OpenClaw container.

The container has `HOME=/data` and `/data/.claude/bin` is already on PATH (bootstrap.sh line 5).

```bash
# SSH to server, exec into container
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100

# Find container name (changes every deploy)
CONTAINER=$(sudo docker ps --format '{{.Names}}' | grep openclaw | head -1)

# Install Claude Code CLI inside container
sudo docker exec -e HOME=/data "$CONTAINER" bash -c '
  curl -fsSL https://claude.ai/install.sh | bash
  # Verify installation
  /data/.claude/bin/claude --version || /data/.local/bin/claude --version
'
```

The native installer puts the binary in `~/.claude/bin/claude` or `~/.local/bin/claude`. Both paths are on PATH.

If the installer fails (network, etc.), fall back to manual download:
```bash
# Manual fallback — download the binary directly
sudo docker exec "$CONTAINER" bash -c '
  mkdir -p /data/.claude/bin
  curl -fsSL -o /data/.claude/bin/claude "https://claude.ai/claude-cli-linux-x64"
  chmod +x /data/.claude/bin/claude
'
```

Set `DISABLE_AUTOUPDATER=1` to prevent auto-updates from breaking things:
```bash
sudo docker exec "$CONTAINER" bash -c 'echo "DISABLE_AUTOUPDATER=1" >> /data/.claude/.env'
```
  </action>
  <verify>
    SSH to server, exec into container, run `claude --version`. Should output a version string.
  </verify>
  <done>Claude Code CLI binary exists on the persistent volume and is executable.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Claude Code CLI installed on the server. Now needs authentication.</what-built>
  <how-to-verify>
**Authentication options — pick one:**

**Option A: ANTHROPIC_API_KEY (recommended for server)**

> **Note on persistence**: bootstrap.sh writes BWS secrets to credential files automatically, but currently only includes `N8N_API_KEY`. If you add `ANTHROPIC_API_KEY` to BWS, also add it to the bootstrap.sh BWS write loop so it survives redeploys:
> ```bash
> # In scripts/bootstrap.sh, find the BWS credential write loop and change:
> for var in N8N_API_KEY; do
> # to:
> for var in N8N_API_KEY ANTHROPIC_API_KEY; do
> ```
> Without this, the credential file is written once manually but will not be recreated after container rebuilds.

1. Go to console.anthropic.com -> API Keys -> Create Key
2. Add the key as a BWS secret named `ANTHROPIC_API_KEY` (and patch bootstrap.sh as above)
3. Or manually write it to the credential file (not persistent across rebuilds without the bootstrap.sh change):
   ```bash
   CONTAINER=$(sudo docker ps --format '{{.Names}}' | grep openclaw | head -1)
   sudo docker exec "$CONTAINER" bash -c 'echo -n "sk-ant-..." > /data/.openclaw/credentials/ANTHROPIC_API_KEY && chmod 600 /data/.openclaw/credentials/ANTHROPIC_API_KEY'
   ```
4. Test: `sudo docker exec "$CONTAINER" bash -c 'ANTHROPIC_API_KEY=$(cat /data/.openclaw/credentials/ANTHROPIC_API_KEY) /data/.claude/bin/claude -p "echo hello" --dangerously-skip-permissions --max-turns 1'`

**Option B: OAuth from Mac (Claude Max plan, no API cost)**
1. On your Mac: `ls ~/.claude/.credentials.json` (verify tokens exist)
2. Copy to server: `scp -r ~/.claude/ ameer@192.168.1.100:/tmp/claude-auth/`
3. Move into container volume:
   ```bash
   sudo cp -r /tmp/claude-auth/.credentials.json /var/lib/docker/volumes/ukwkggw4o8go0wgg804oc4oo_openclaw-data/_data/.claude/
   sudo cp /tmp/claude-auth/.claude.json /var/lib/docker/volumes/ukwkggw4o8go0wgg804oc4oo_openclaw-data/_data/.claude.json 2>/dev/null || true
   ```
4. Test: `sudo docker exec "$CONTAINER" bash -c '/data/.claude/bin/claude -p "echo hello" --dangerously-skip-permissions --max-turns 1'`

Type "authenticated" once Claude Code responds to the test command, or describe any errors.
  </how-to-verify>
  <resume-signal>Type "authenticated" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. SSH into server, exec into container
2. Run: `claude --version` -> outputs version
3. Run: `ANTHROPIC_API_KEY=$(cat /data/.openclaw/credentials/ANTHROPIC_API_KEY) claude -p "Say hello" --dangerously-skip-permissions --max-turns 1` -> outputs response
</verification>

<success_criteria>
- Claude Code CLI is installed at a persistent path on the volume
- Claude Code can execute a simple task headlessly
- Authentication persists across container restarts
</success_criteria>

<output>
After completion, create `.planning/phases/08-the-organization-director-workforce/08-02-SUMMARY.md`
</output>
