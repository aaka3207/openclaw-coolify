---
phase: 08-the-organization-director-workforce
plan: "02"
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - scripts/bootstrap.sh
autonomous: false

user_setup:
  - service: anthropic-api
    why: "Claude Code CLI requires ANTHROPIC_API_KEY for headless server use. The Claude Max plan OAuth flow requires a browser — not viable for a server container. A direct API key from console.anthropic.com is needed."
    env_vars:
      - name: ANTHROPIC_API_KEY
        source: "console.anthropic.com -> API Keys -> Create key (or copy existing)"
    dashboard_config:
      - task: "Add ANTHROPIC_API_KEY to BWS vault under the openclaw-coolify project"
        location: "Bitwarden Secrets Manager -> openclaw-coolify project -> New Secret"

must_haves:
  truths:
    - "Claude Code CLI is installed at /data/.local/bin/claude on the persistent volume"
    - "ANTHROPIC_API_KEY credential file exists at /data/.openclaw/credentials/ANTHROPIC_API_KEY"
    - "claude --version runs successfully inside the container"
    - "claude -p test invocation exits 0 with ANTHROPIC_API_KEY set"
    - "Auto-updater is disabled (DISABLE_AUTOUPDATER=1 set for claude)"
    - "bootstrap.sh DISABLE_AUTOUPDATER setting exists in /data/.claude/ env"
  artifacts:
    - path: "scripts/bootstrap.sh"
      provides: "DISABLE_AUTOUPDATER env file write to /data/.claude/settings.env"
      contains: "DISABLE_AUTOUPDATER"
  key_links:
    - from: "/data/.openclaw/credentials/ANTHROPIC_API_KEY"
      to: "/data/.local/bin/claude"
      via: "ANTHROPIC_API_KEY env var read by Automation Supervisor before claude -p invocation"
      pattern: "cat /data/.openclaw/credentials/ANTHROPIC_API_KEY"
---

<objective>
Install Claude Code CLI on the server and configure auth for headless invocation by the Automation Supervisor. Claude Code is the execution layer the Supervisor uses for complex infrastructure tasks — n8n workflow diagnosis, building microservices, infrastructure changes too complex for direct tool calls.

Purpose: Without this, the Automation Supervisor can reason but cannot execute. The Supervisor's SOUL.md (08-01) documents the `claude -p` invocation pattern — this plan makes it work.
Output: `claude` binary at `/data/.local/bin/claude`, ANTHROPIC_API_KEY credential file, auto-update disabled.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@scripts/bootstrap.sh
@.planning/phases/08-the-organization-director-workforce/08-CONTEXT.md
@.planning/phases/08-the-organization-director-workforce/08-RESEARCH.md
@.planning/phases/08-the-organization-director-workforce/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DISABLE_AUTOUPDATER env write to bootstrap.sh</name>
  <files>scripts/bootstrap.sh</files>
  <action>
Add a small block to bootstrap.sh that writes the Claude Code settings env file to disable auto-updates. Insert AFTER the BWS credential write loop (after the `for var in N8N_API_KEY ANTHROPIC_API_KEY` block) and BEFORE the NOVA Memory section.

```bash
# Claude Code CLI: disable auto-updater on server (prevents version drift)
# Per ARCHITECTURE_REFINEMENT.md Section on Automation Supervisor
CLAUDE_DIR="/data/.claude"
mkdir -p "$CLAUDE_DIR"
CLAUDE_SETTINGS_ENV="$CLAUDE_DIR/settings.env"
if ! grep -q "DISABLE_AUTOUPDATER" "$CLAUDE_SETTINGS_ENV" 2>/dev/null; then
  echo "DISABLE_AUTOUPDATER=1" >> "$CLAUDE_SETTINGS_ENV"
  echo "[claude] Wrote DISABLE_AUTOUPDATER=1 to $CLAUDE_SETTINGS_ENV"
fi
```

This is safe — `/data/.claude/` is already created in the mkdir loop at the top of bootstrap.sh (line ~64). The settings.env write is idempotent via the grep check.

Note: `/data/.claude/` is on the persistent volume (HOME=/data). The Claude Code installer writes to `~/.local/bin/claude` which resolves to `/data/.local/bin/claude` — also on the persistent volume. No PATH changes needed (bootstrap.sh already adds `/data/.local/bin` at line 5).
  </action>
  <verify>
```bash
bash -n scripts/bootstrap.sh && echo "syntax OK"
grep "DISABLE_AUTOUPDATER" scripts/bootstrap.sh
```
  </verify>
  <done>
- bash -n passes
- DISABLE_AUTOUPDATER write block exists in bootstrap.sh
- Block is idempotent (grep check before write)
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <what-built>
bootstrap.sh now writes DISABLE_AUTOUPDATER=1 to /data/.claude/settings.env on every boot. The Automation Supervisor's SOUL.md documents the `claude -p` invocation pattern with ANTHROPIC_API_KEY. The 08-01 deploy added automation-supervisor to agents.list.

Two manual steps are needed to complete Claude Code auth for headless server use:
1. SSH into the server container and install Claude Code CLI (one-time install, survives redeploys)
2. Verify ANTHROPIC_API_KEY is in BWS and gets written to the credential file
  </what-built>
  <how-to-verify>
**Step 1 — Get container name:**
```bash
ssh ameer@192.168.1.100
sudo docker ps --format '{{.Names}}' | grep openclaw | grep -v proxy | grep -v searxng
```

**Step 2 — Install Claude Code CLI inside the container:**
```bash
CONTAINER=<name from step 1>
sudo docker exec -it $CONTAINER bash
# Inside container:
curl -fsSL https://claude.ai/install.sh | bash
# This installs to /data/.local/bin/claude (persistent volume)
# Verify:
/data/.local/bin/claude --version
```

**Step 3 — Verify ANTHROPIC_API_KEY credential file:**
If you have ANTHROPIC_API_KEY in BWS, it should already be at `/data/.openclaw/credentials/ANTHROPIC_API_KEY` after the 08-01 deploy. Check:
```bash
sudo docker exec $CONTAINER ls -la /data/.openclaw/credentials/ANTHROPIC_API_KEY
```
If the file is missing, either:
- Add `ANTHROPIC_API_KEY` to your BWS vault and trigger a redeploy (git push an empty commit), OR
- Manually write it: `sudo docker exec $CONTAINER bash -c "echo 'sk-ant-...' > /data/.openclaw/credentials/ANTHROPIC_API_KEY && chmod 600 /data/.openclaw/credentials/ANTHROPIC_API_KEY"`

**Step 4 — Test headless invocation:**
```bash
sudo docker exec $CONTAINER bash -c '
  ANTHROPIC_API_KEY="$(cat /data/.openclaw/credentials/ANTHROPIC_API_KEY)" \
  /data/.local/bin/claude -p "Say: Claude Code is working" \
  --dangerously-skip-permissions \
  --max-turns 1 \
  --output-format json \
  --no-session-persistence
'
```
Expected: JSON output containing "Claude Code is working" (or similar). Exit code 0.

**Step 5 — Verify auto-update disabled:**
```bash
sudo docker exec $CONTAINER cat /data/.claude/settings.env
```
Expected: contains `DISABLE_AUTOUPDATER=1`
  </how-to-verify>
  <resume-signal>Type "claude-ready" when all 5 steps pass, or describe what failed so the plan can be adjusted.</resume-signal>
</task>

</tasks>

<verification>
After checkpoint approval:
- `/data/.local/bin/claude --version` returns a version string from inside the container
- `cat /data/.openclaw/credentials/ANTHROPIC_API_KEY` returns the key (non-empty)
- Headless test `claude -p "Say hello" --dangerously-skip-permissions --max-turns 1 --output-format json --no-session-persistence` exits 0
- `/data/.claude/settings.env` contains `DISABLE_AUTOUPDATER=1`
</verification>

<success_criteria>
- Claude Code CLI installed at /data/.local/bin/claude (persistent volume — survives redeploys)
- ANTHROPIC_API_KEY credential file exists at /data/.openclaw/credentials/ANTHROPIC_API_KEY
- Headless invocation `claude -p` exits 0 with ANTHROPIC_API_KEY from credential file
- Auto-updater disabled in /data/.claude/settings.env
</success_criteria>

<output>
After completion, create `.planning/phases/08-the-organization-director-workforce/08-02-SUMMARY.md`

Include:
- Claude Code version installed
- Whether ANTHROPIC_API_KEY came from BWS or was written manually
- Result of the headless test invocation (output snippet)
- Whether the install survived a container restart (test by restarting and running --version again)
- Any issues encountered and how they were resolved
</output>
