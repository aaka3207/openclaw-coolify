---
phase: 07-tailscale-integration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Control UI is accessible via HTTPS from MacBook browser"
    - "Sub-agents still spawn and work correctly"
    - "Gateway survives container restart without Tailscale re-auth"
    - "n8n has no Tailscale access — remains LAN-only"
  artifacts: []
  key_links: []
---

<objective>
Deploy the Tailscale-enabled build, verify Control UI works via HTTPS, confirm sub-agents still function, and validate persistence across restarts.

Purpose: All code changes from Plan 01 must be deployed and tested end-to-end. This is a human verification checkpoint since visual UI testing and multi-device networking cannot be automated.
Output: Confirmed working deployment with Control UI accessible via Tailscale HTTPS.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-tailscale-integration/07-RESEARCH.md
@.planning/phases/07-tailscale-integration/07-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Pre-deploy — User Tailscale setup</name>
  <what-built>Plan 01 committed all code changes. Before deploying, the user must complete Tailscale account setup.</what-built>
  <how-to-verify>
Complete these steps (one-time setup):

1. **Create Tailscale account** (if not already done):
   - Go to https://login.tailscale.com
   - Sign up (free tier: 100 devices, 3 users)

2. **Create ACL tag** for the server:
   - Tailscale Admin -> Access Controls
   - Add `"tag:server"` to the `tagOwners` section
   - Save

3. **Create OAuth client secret**:
   - Tailscale Admin -> Settings -> OAuth clients -> Generate OAuth client
   - Scope: `devices` (write) — this allows creating auth keys
   - Tags: `tag:server`
   - Copy the `tskey-client-...` secret

4. **Add to Coolify environment**:
   - Coolify Dashboard -> openclaw service -> Environment Variables
   - Add: `TS_AUTHKEY=tskey-client-...` (the secret from step 3)
   - Add: `TS_HOSTNAME=openclaw-server` (optional, sets the tailnet machine name)

5. **Enable MagicDNS**:
   - Tailscale Admin -> DNS -> Enable MagicDNS

6. **Install Tailscale on MacBook**:
   - `brew install --cask tailscale`
   - Open Tailscale.app and login with the same account
   - Verify: `tailscale status` shows your MacBook connected

7. **Push the commit** to trigger Coolify deploy:
   - `git push origin main`
   - Watch Coolify build logs for the new tailscale-install stage
   - Wait for deploy to complete (first build may take longer due to new stage)

Type "deployed" when the container is running and Tailscale setup is complete.
  </how-to-verify>
  <resume-signal>Type "deployed" when Tailscale is set up and container is running</resume-signal>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Post-deploy — Verify Tailscale + Control UI + sub-agents</name>
  <what-built>Tailscale Serve should now be proxying HTTPS traffic to the openclaw gateway on loopback. Control UI should be accessible via the MagicDNS URL.</what-built>
  <how-to-verify>
**Step 1: Check Tailscale status on server**
```bash
# SSH into server
sshpass -p '@pack86N5891' ssh -o StrictHostKeyChecking=no -o PreferredAuthentications=password ameer@192.168.1.100

# Check container tailscale status
CONTAINER=$(sudo docker ps --format '{{.Names}}' | grep openclaw | head -1)
sudo docker exec "$CONTAINER" tailscale --socket=/var/run/tailscale/tailscaled.sock status
```
Expected: Shows "openclaw-server" with a 100.x.x.x IP and "Running" state.

**Step 2: Get the MagicDNS URL**
```bash
sudo docker exec "$CONTAINER" tailscale --socket=/var/run/tailscale/tailscaled.sock status | head -3
```
Note the tailnet name (e.g., `tail12345.ts.net`). Your Control UI URL is: `https://openclaw-server.TAILNET.ts.net`

**Step 3: Access Control UI from MacBook**
- Open browser on MacBook
- Navigate to `https://openclaw-server.TAILNET.ts.net`
- Expected: Control UI loads WITHOUT "requires secure context" error
- Expected: Valid HTTPS certificate (no browser warning)
- Enter the gateway token when prompted

**Step 4: Verify sub-agents still work**
- In Control UI or via chat, trigger a sub-agent (e.g., ask OpenClaw to research something that spawns a sub-agent)
- Expected: Sub-agent spawns and connects without "ECONNREFUSED" errors
- Check logs: `sudo docker logs "$CONTAINER" 2>&1 | tail -50`

**Step 4a: Verify gateway.remote removed from volume config**
```bash
sudo docker exec "$CONTAINER" jq '.gateway.remote' /data/.openclaw/openclaw.json
```
Expected: `null` (confirms the cleanup patch removed the stale remote config)

**Step 4b: Verify cleanup patch ran in logs**
```bash
sudo docker logs "$CONTAINER" 2>&1 | grep -E '\[config\] (Removed gateway\.remote|Reverted gateway\.mode)'
```
Expected: One or both log lines present (confirms bootstrap.sh cleaned up the temp patches on this boot). If neither line appears, the config was already clean (also acceptable).

**Step 5: Verify LAN access is gone (expected)**
```bash
# From MacBook terminal:
curl -s http://192.168.1.100:18789/health
```
Expected: Connection refused or timeout (this is correct — bind=loopback means no LAN access)

**Step 6: Verify n8n network isolation from tailnet**
From your MacBook (which is on the tailnet), attempt to reach n8n's LAN URL:
```bash
# From MacBook terminal — this tests that n8n is NOT reachable via tailnet
curl -m 5 http://192.168.1.100:5678/ 2>&1
```
Expected: Connection timeout or refused. n8n listens on LAN only and has no Tailscale exposure. If this succeeds, n8n is still reachable on LAN from the MacBook (which is expected if MacBook is on the same LAN) — in that case, disconnect from WiFi and test over Tailscale-only:
```bash
# With WiFi disconnected (Tailscale-only connectivity):
curl -m 5 http://192.168.1.100:5678/ 2>&1
```
Expected: Timeout/refused when only connected via Tailscale (confirms n8n has no tailnet route).

Also verify n8n is not listed as a tailnet device:
```bash
sudo docker exec "$CONTAINER" tailscale --socket=/var/run/tailscale/tailscaled.sock status
```
Expected: Only openclaw-server and your MacBook. No n8n, searxng, or other services.

**Step 7: Verify restart persistence**
```bash
# Restart the container
sudo docker restart "$CONTAINER"
# Wait 60 seconds for startup
sleep 60
# Check tailscale reconnected automatically
sudo docker exec "$CONTAINER" tailscale --socket=/var/run/tailscale/tailscaled.sock status
```
Expected: Tailscale reconnects automatically from persisted state (no re-auth needed).

**Step 8: Update connect-mac-node.sh**
- Edit `scripts/connect-mac-node.sh` on your Mac
- Replace `CHANGE-ME` with your actual tailnet name
- Test: `./scripts/connect-mac-node.sh`
- Expected: Node connects via Tailscale HTTPS, browser control works

Report results for each step. If any step fails, describe what happened.
  </how-to-verify>
  <resume-signal>Report results for all 8 steps, or describe any failures</resume-signal>
</task>

</tasks>

<verification>
All verification is human-driven (network + browser testing):
1. Control UI loads via HTTPS MagicDNS URL
2. Sub-agents spawn without errors
3. gateway.remote is null in volume config (Step 4a)
4. Cleanup patch log lines confirm temp patch removal (Step 4b)
5. n8n is not reachable via Tailscale-only connectivity
6. Container restart preserves Tailscale state
7. connect-mac-node.sh works with Tailscale URL
</verification>

<success_criteria>
- Control UI accessible from MacBook browser via HTTPS (no "secure context" error)
- Sub-agents continue to work (loopback-native, no temp patch)
- gateway.remote is null in openclaw.json (cleanup confirmed)
- n8n has NO Tailscale access — LAN-only unchanged (verified via Tailscale-only curl)
- Gateway survives container restart without re-auth (state persisted in /data/tailscale/)
- TS_AUTHKEY stored in Coolify env (via BWS or direct)
- connect-mac-node.sh works with Tailscale MagicDNS URL
</success_criteria>

<output>
After completion, create `.planning/phases/07-tailscale-integration/07-02-SUMMARY.md`
</output>
